<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Shopee Monitor BY aumsound - Complete Settings</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Chart.js ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏≤‡∏ü -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary-color: #ee4d2d;
            --secondary-color: #ff6b35;
            --success-color: #4CAF50;
            --warning-color: #ff9800;
            --danger-color: #f44336;
            --dark-bg: #1a1a2e;
            --card-bg: #16213e;
            --text-light: #ffffff;
            --text-muted: #a8b2d1;
            --border-color: #233554;
            --shadow: 0 10px 30px rgba(0,0,0,0.3);
            --shadow-hover: 0 15px 40px rgba(238,77,45,0.2);
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #0f3460 100%);
            color: var(--text-light);
            min-height: 100vh;
            line-height: 1.6;
        }
        
        /* Header Styles */
        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgba(238,77,45,0.3);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: white;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            transition: transform 0.3s;
        }
        
        .logo:hover {
            transform: scale(1.05);
        }
        
        .logo i {
            font-size: 1.8rem;
        }
        
        .header-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .update-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            backdrop-filter: blur(10px);
        }
        
        .update-status.warning {
            animation: pulse 2s infinite;
            background: rgba(255,152,0,0.2);
            border: 2px solid var(--warning-color);
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.02); }
        }
        
        @keyframes pulseRed {
            0% { background: rgba(139, 0, 0, 0.3); border-color: #8B0000; }
            50% { background: rgba(255, 0, 0, 0.4); border-color: #FF0000; }
            100% { background: rgba(139, 0, 0, 0.3); border-color: #8B0000; }
        }
        
        .update-status.warning-critical {
            animation: pulseRed 1.5s infinite;
            background: rgba(139, 0, 0, 0.3);
            border: 2px solid #8B0000;
        }
        
        /* Settings Button */
        .settings-btn {
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .settings-btn:hover {
            background: rgba(255,255,255,0.2);
            transform: scale(1.05);
        }
        
        /* Settings Modal */
        .settings-modal {
            display: none;
            position: fixed;
            z-index: 3000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            animation: fadeIn 0.3s;
        }
        
        .settings-modal.show {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .settings-content {
            background: linear-gradient(135deg, #1e2139 0%, #252844 100%);
            padding: 2rem;
            border-radius: 16px;
            border: 2px solid var(--primary-color);
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            animation: slideIn 0.3s;
        }
        
        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border-color);
        }
        
        .settings-title {
            font-size: 1.5rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .settings-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
            transition: color 0.3s;
        }
        
        .settings-close:hover {
            color: var(--primary-color);
        }
        
        .settings-section {
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
        }
        
        .settings-section-title {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 1rem;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .settings-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.8rem;
            padding: 0.5rem;
            background: rgba(255,255,255,0.03);
            border-radius: 4px;
        }
        
        .settings-label {
            flex: 1;
            color: var(--text-light);
        }
        
        .settings-input-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .settings-input {
            width: 80px;
            padding: 0.4rem;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-light);
            text-align: center;
        }
        
        .settings-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .settings-actions {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
        }
        
        .settings-btn-save,
        .settings-btn-reset,
        .settings-btn-cancel {
            padding: 0.6rem 1.5rem;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .settings-btn-save {
            background: var(--primary-color);
            color: white;
        }
        
        .settings-btn-save:hover {
            background: var(--secondary-color);
            transform: translateY(-2px);
        }
        
        .settings-btn-reset {
            background: var(--warning-color);
            color: white;
        }
        
        .settings-btn-reset:hover {
            background: #e68900;
            transform: translateY(-2px);
        }
        
        .settings-btn-cancel {
            background: var(--card-bg);
            color: var(--text-light);
            border: 1px solid var(--border-color);
        }
        
        .settings-btn-cancel:hover {
            background: rgba(255,255,255,0.1);
        }
        
        /* Copy Names Button */
        .copy-names-btn {
            position: fixed;
            bottom: 80px;
            right: 20px;
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 0.95rem;
            box-shadow: 0 4px 15px rgba(76,175,80,0.3);
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 999;
        }
        
        .copy-names-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(76,175,80,0.4);
        }
        
        .copy-names-btn.copied {
            background: linear-gradient(135deg, #4CAF50, #2e7d32);
            animation: successPulse 0.5s;
        }
        
        @keyframes successPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .copy-tooltip {
            position: absolute;
            bottom: 100%;
            right: 0;
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            margin-bottom: 8px;
        }
        
        .copy-tooltip.show {
            opacity: 1;
        }
        
        .copy-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            right: 20px;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 6px solid rgba(0,0,0,0.9);
        }
        
        /* TABLE LOADING OVERLAY */
        .table-loading-overlay {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(26, 26, 46, 0.95);
            z-index: 100;
            border-radius: 16px;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            gap: 1rem;
            backdrop-filter: blur(5px);
        }
        
        .table-loading-overlay.show {
            display: flex;
        }
        
        .table-loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(238, 77, 45, 0.2);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .table-loading-text {
            color: var(--text-light);
            font-size: 1.1rem;
            font-weight: 500;
        }
        
        .table-loading-subtext {
            color: var(--text-muted);
            font-size: 0.9rem;
        }
        
        /* PROCESSING INDICATOR */
        .processing-indicator {
            display: none;
            position: fixed;
            top: 100px;
            right: 20px;
            background: var(--card-bg);
            border: 2px solid var(--primary-color);
            border-radius: 12px;
            padding: 1rem 1.5rem;
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
            z-index: 1500;
            align-items: center;
            gap: 1rem;
        }
        
        .processing-indicator.show {
            display: flex;
            animation: slideInRight 0.3s ease;
        }
        
        .processing-spinner {
            width: 24px;
            height: 24px;
            border: 3px solid rgba(238, 77, 45, 0.2);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .processing-text {
            color: var(--text-light);
            font-size: 0.95rem;
        }
        
        /* Sound Control Button */
        .sound-control {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .sound-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        
        .sound-btn:hover {
            transform: scale(1.1);
            background: var(--secondary-color);
        }
        
        .sound-btn.muted {
            background: #666;
        }
        
        .sound-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Alert Toast */
        .alert-toast {
            position: fixed;
            top: 80px;
            right: 20px;
            background: rgba(220, 20, 60, 0.95);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            z-index: 2000;
            display: none;
            animation: slideInRight 0.5s;
        }
        
        @keyframes slideInRight {
            from { transform: translateX(400px); }
            to { transform: translateX(0); }
        }
        
        .alert-toast.show {
            display: block;
        }
        
        /* Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }
        
        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        /* Card Styles */
        .card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            border: 1px solid var(--border-color);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-hover);
            border-color: var(--primary-color);
        }
        
        .card.loading {
            pointer-events: none;
            opacity: 0.7;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .card-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.1rem;
            color: var(--text-muted);
        }
        
        .card-title i {
            color: var(--primary-color);
        }
        
        .card-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--text-light);
        }
        
        .card-description {
            color: var(--text-muted);
            font-size: 0.9rem;
        }
        
        .card-icon {
            position: absolute;
            bottom: 10px;
            right: 10px;
            font-size: 4rem;
            opacity: 0.1;
            color: var(--primary-color);
        }
        
        .card.status-live {
            border-left: 4px solid var(--success-color);
        }
        
        .card.status-warning {
            border-left: 4px solid var(--warning-color);
        }
        
        .card.status-stop {
            border-left: 4px solid var(--danger-color);
        }
        
        /* Loading Spinner */
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 3000;
            display: none;
        }
        
        .loading.show {
            display: block;
        }
        
        .spinner {
            border: 4px solid rgba(255,255,255,0.1);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Stop List - COMPACT VERSION */
        .stop-list {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            position: relative;
        }
        
        .stop-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }
        
        .stop-list-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        .stop-list-title i {
            color: var(--danger-color);
        }
        
        .stop-items {
            max-height: 400px;
            overflow-y: auto;
        }
        
        /* COMPACT STOP ITEM DESIGN */
        .stop-item {
            padding: 0.5rem;
            margin: 0.25rem 0;
            background: rgba(255,255,255,0.03);
            border-radius: 6px;
            transition: background 0.3s;
            border-left: 2px solid var(--danger-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
        }
        
        .stop-item:hover {
            background: rgba(255,255,255,0.08);
        }
        
        .stop-item-left {
            flex: 1;
            min-width: 0;
        }
        
        .stop-item-channel {
            font-weight: 600;
            color: var(--text-light);
            font-size: 0.95rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .stop-item-time {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 2px;
        }
        
        .stop-item-stats {
            display: flex;
            gap: 1.5rem;
            align-items: center;
            flex-shrink: 0;
        }
        
        .stop-stat {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 45px;
        }
        
        .stop-stat-value {
            font-size: 0.95rem;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .stop-stat-label {
            font-size: 0.65rem;
            color: var(--text-muted);
            margin-top: 1px;
        }
        
        .stop-item-badge {
            flex-shrink: 0;
        }
        
        /* Badge Styles */
        .badge {
            display: inline-block;
            padding: 3px 6px;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .badge-live {
            background: rgba(76, 175, 80, 0.2);
            color: var(--success-color);
            border: 1px solid var(--success-color);
        }
        
        .badge-offline {
            background: rgba(244, 67, 54, 0.2);
            color: var(--danger-color);
            border: 1px solid var(--danger-color);
        }
        
        /* Detail Container */
        .detail-container {
            display: none;
        }
        
        .detail-container.show {
            display: block;
        }
        
        .detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 0; /* ‡∏•‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏° '2rem' ‡∏≠‡∏≠‡∏Å */
            flex-grow: 1; /* ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Ç‡∏¢‡∏≤‡∏¢‡πÄ‡∏ï‡πá‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠ */
        }
        .detail-title {
            font-size: 1.5rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .detail-title i {
            color: var(--primary-color);
        }
        
        .filter-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .filter-input {
            padding: 0.5rem 1rem;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-light);
            width: 200px;
        }
        
        .filter-input:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .filter-select {
            padding: 0.5rem 1rem;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-light);
            cursor: pointer;
        }
        
        .filter-select:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Table Styles */
        .table-container {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            overflow-x: auto;
            position: relative;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .data-table th {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            cursor: pointer;
            user-select: none;
            position: sticky;
            top: 0;
            z-index: 10;
            transition: all 0.3s;
        }
        
        .data-table th:hover {
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
        }
        
        .data-table th i {
            margin-left: 3px; /* ‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î margin */
            font-size: 0.7rem; /* ‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î icon */
            opacity: 0.7;
            transition: all 0.3s ease;
        }
        
        .data-table th:hover i {
            transform: translateY(-2px);
        }

        /* NEW: ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡πÅ‡∏ñ‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏•‡∏±‡∏ö‡πÅ‡∏•‡∏∞ filter ‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô */
        .detail-top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem; /* ‡πÄ‡∏ß‡πâ‡∏ô‡∏£‡∏∞‡∏¢‡∏∞‡∏Å‡πà‡∏≠‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á */
            flex-wrap: wrap; /* responsive */
            gap: 1rem;
        }

        .data-table td {
            padding: 8px 6px; /* ‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î padding */
            border-bottom: 1px solid var(--border-color);
            color: var(--text-light);
            font-size: 0.85rem; /* ‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£ */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .data-table tr:hover {
            background: rgba(238, 77, 45, 0.1);
        }
        
        .data-table tbody tr {
            transition: all 0.3s;
        }
        
        /* Back Button - (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç) ‡∏•‡∏ö margin-bottom ‡∏≠‡∏≠‡∏Å */
        .back-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s;
            margin-bottom: 0; /* ‡∏•‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏° '1rem' ‡∏≠‡∏≠‡∏Å */
        }

        .back-btn:hover {
            background: var(--secondary-color);
            transform: translateX(-5px);
        }
        
        .back-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-muted);
        }
        
        .empty-state i {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }
        
        /* Channel Name Click Style */
        .channel-link {
            color: #4fb3d9;
            cursor: pointer;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
            position: relative;
            padding: 2px 4px;
            border-radius: 4px;
        }
        
        .channel-link:hover {
            color: #fff;
            background: rgba(79, 179, 217, 0.2);
            transform: translateX(2px);
        }
        
        .channel-link:active {
            transform: scale(0.98);
        }
        
        /* Mini Chart Container */
        .mini-chart-cell {
            padding: 4px !important;
            width: 120px;
            height: 40px;
            position: relative;
        }
        
        .mini-chart {
            width: 100%;
            height: 100%;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        
        .mini-chart:hover {
            transform: scale(1.05);
        }
        
        /* Modal for Historical Data */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.8);
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-content {
            background: linear-gradient(135deg, #1e2139 0%, #252844 100%);
            margin: 2% auto;
            padding: 30px;
            border: 2px solid var(--primary-color);
            width: 90%;
            max-width: 1200px;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            animation: slideIn 0.3s;
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s;
        }
        
        .close:hover,
        .close:focus {
            color: var(--primary-color);
        }
        
        /* Historical Data Styles */
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
        }
        
        .history-title {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .history-title i {
            font-size: 1.5rem;
        }
        
        .date-filter {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .date-btn {
            padding: 8px 16px;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            color: var(--text-light);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
        }
        
        .date-btn:hover {
            background: var(--primary-color);
            border-color: var(--primary-color);
            transform: translateY(-2px);
        }
        
        .date-btn.active {
            background: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .date-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Chart Container */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .chart-card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow);
        }
        
        .chart-title {
            font-size: 1.1rem;
            color: var(--text-light);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .chart-title i {
            color: var(--primary-color);
        }
        
        .chart-container {
            position: relative;
            height: 300px;
        }
        
        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, var(--card-bg) 0%, #1e2847 100%);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            text-align: center;
            transition: all 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-hover);
            border-color: var(--primary-color);
        }
        
        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: var(--text-muted);
        }
        
        .stat-change {
            font-size: 0.85rem;
            margin-top: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        
        .stat-change.positive {
            color: var(--success-color);
        }
        
        .stat-change.negative {
            color: var(--danger-color);
        }
        
        /* Data Table */
        .history-table {
            width: 100%;
            background: var(--card-bg);
            border-radius: 10px;
            overflow: hidden;
            margin-top: 20px;
        }
        
        .history-table table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .history-table th {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        
        .history-table td {
            padding: 10px 12px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-light);
        }
        
        .history-table tr:hover {
            background: rgba(238, 77, 45, 0.1);
        }
        
        /* Loading Spinner */
        .loading-spinner {
            display: none;
            text-align: center;
            padding: 40px;
        }
        
        .loading-spinner.active {
            display: block;
        }
        
        .spinner-modal {
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }


        /* Responsive */
        @media (max-width: 768px) {
            .header-controls {
                flex-direction: column;
                width: 100%;
            }
            
            .copy-names-btn {
                bottom: 140px;
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                width: 95%;
                padding: 20px;
                margin: 5% auto;
            }
            
            .history-header {
                flex-direction: column;
                gap: 15px;
            }
            
            .date-filter {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .mini-chart-cell {
                width: 80px;
                height: 30px;
            }
            
            .stop-item-stats {
                gap: 0.8rem;
            }
            
            .stop-stat {
                min-width: 35px;
            }
            
            .stop-stat-value {
                font-size: 0.85rem;
            }
            
            .stop-stat-label {
                font-size: 0.6rem;
            }
            
            .settings-content {
                width: 95%;
                padding: 1.5rem;
            }
            
            .settings-row {
                flex-direction: column;
                gap: 0.5rem;
                align-items: flex-start;
            }
            
            .settings-input {
                width: 100%;
            }
            
            /* Table responsive - ‡∏ó‡∏≥‡πÉ‡∏´‡πâ scroll horizontal ‡πÑ‡∏î‡πâ */
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .data-table {
                min-width: 1200px; /* ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ */
            }
            
            /* ‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î font ‡πÅ‡∏•‡∏∞ padding ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏à‡∏≠‡πÄ‡∏•‡πá‡∏Å */
            .data-table th,
            .data-table td {
                font-size: 0.75rem;
                padding: 6px 4px;
            }
        }
        
        /* ‡πÑ‡∏Æ‡πÑ‡∏•‡∏ó‡πå‡πÅ‡∏ñ‡∏ß‡∏™‡∏µ‡πÅ‡∏î‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏ñ‡πÄ‡∏Ç‡πá‡∏ô 3 ‡∏ä‡∏°.‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î */
        .no-cart-row {
            background-color: rgba(220, 53, 69, 0.3) !important;
        }
        .no-cart-row:hover {
            background-color: rgba(220, 53, 69, 0.5) !important;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <a href="#" class="logo" onclick="showDashboard()">
                <i class="fas fa-store"></i>
                <span>Live Shopee Monitor BY aumsound</span>
            </a>
            <div class="header-controls">
                <div class="update-status" id="updateStatus">
                    <i class="fas fa-clock"></i>
                    <span>‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: <span id="lastUpdate">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span></span>
                </div>
                <button class="settings-btn" onclick="openSettings()">
                    <i class="fas fa-cog"></i>
                    <span>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</span>
                </button>
            </div>
        </div>
    </header>
    
    <!-- Settings Modal -->
    <div class="settings-modal" id="settingsModal">
        <div class="settings-content">
            <div class="settings-header">
                <div class="settings-title">
                    <i class="fas fa-cog"></i>
                    <span>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</span>
                </div>
                <button class="settings-close" onclick="closeSettings()">&times;</button>
            </div>
            
            <div class="settings-section">
                <div class="settings-section-title">
                    <i class="fas fa-clock"></i>
                    <span>‡πÑ‡∏•‡∏ü‡πå‡∏ô‡∏≤‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô</span>
                </div>
                
                <div class="settings-row">
                    <div class="settings-label">‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö 1:</div>
                    <div class="settings-input-group">
                        <input type="number" class="settings-input" id="alertHours1" value="36" min="1" max="168">
                        <span>‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</span>
                        <label>
                            <input type="checkbox" class="settings-checkbox" id="alertSound1" checked>
                            <span>üîä</span>
                        </label>
                    </div>
                </div>
                
                <div class="settings-row">
                    <div class="settings-label">‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö 2:</div>
                    <div class="settings-input-group">
                        <input type="number" class="settings-input" id="alertHours2" value="46" min="1" max="168">
                        <span>‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</span>
                        <label>
                            <input type="checkbox" class="settings-checkbox" id="alertSound2" checked>
                            <span>üîä</span>
                        </label>
                    </div>
                </div>
            </div>
            
            <div class="settings-section">
                <div class="settings-section-title">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>Bot ‡πÑ‡∏°‡πà‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó</span>
                </div>
                
                <div class="settings-row">
                    <div class="settings-label">‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á:</div>
                    <div class="settings-input-group">
                        <input type="number" class="settings-input" id="updateWarning" value="10" min="1" max="60">
                        <span>‡∏ô‡∏≤‡∏ó‡∏µ</span>
                    </div>
                </div>
                
                <div class="settings-row">
                    <div class="settings-label">‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÅ‡∏î‡∏á:</div>
                    <div class="settings-input-group">
                        <input type="number" class="settings-input" id="updateCritical" value="20" min="1" max="120">
                        <span>‡∏ô‡∏≤‡∏ó‡∏µ</span>
                    </div>
                </div>
                
                <div class="settings-row">
                    <div class="settings-label">‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏•‡πà‡∏≤‡∏ä‡πâ‡∏≤:</div>
                    <div class="settings-input-group">
                        <label>
                            <input type="checkbox" class="settings-checkbox" id="updateAlertSound" checked>
                            <span>‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</span>
                        </label>
                    </div>
                </div>
            </div>
            
            <div class="settings-section">
                <div class="settings-section-title">
                    <i class="fas fa-sort"></i>
                    <span>‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö</span>
                </div>
                
                <div class="settings-row">
                    <div class="settings-label">‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô:</div>
                    <div class="settings-input-group">
                        <label>
                            <input type="checkbox" class="settings-checkbox" id="sortNewestFirst" checked>
                            <span>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏ô‡πÄ‡∏™‡∏°‡∏≠</span>
                        </label>
                    </div>
                </div>
            </div>
            
            <div class="settings-actions">
                <button class="settings-btn-save" onclick="saveSettings()">
                    <i class="fas fa-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                </button>
                <button class="settings-btn-reset" onclick="resetSettings()">
                    <i class="fas fa-undo"></i> ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï
                </button>
                <button class="settings-btn-cancel" onclick="closeSettings()">
                    <i class="fas fa-times"></i> ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                </button>
            </div>
        </div>
    </div>
    
    <!-- Copy Names Button -->
    <button class="copy-names-btn" onclick="copyAllChannelNames()" id="copyNamesBtn">
        <i class="fas fa-copy"></i>
        <span id="copyBtnText">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡πà‡∏≠‡∏á</span>
        <div class="copy-tooltip" id="copyTooltip">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß!</div>
    </button>
    
    <!-- Loading Spinner -->
    <div class="loading" id="loading">
        <div class="spinner"></div>
    </div>
    
    <!-- Processing Indicator -->
    <div class="processing-indicator" id="processingIndicator">
        <div class="processing-spinner"></div>
        <div class="processing-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</div>
    </div>
    
    <!-- Main Dashboard -->
    <div class="container" id="dashboard">
        <div class="dashboard-grid">
            <!-- ‡∏´‡∏¢‡∏∏‡∏î‡πÑ‡∏•‡∏û‡πå Card -->
            <div class="card status-stop" onclick="showDetail('stop_shopee')">
                <div class="card-header">
                    <div class="card-title">
                        <i class="fas fa-stop-circle"></i>
                        <span>‡∏´‡∏¢‡∏∏‡∏î‡πÑ‡∏•‡∏û‡πå</span>
                    </div>
                    <div class="card-value" id="stopCount">0</div>
                </div>
                <div class="card-description">‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏´‡∏¢‡∏∏‡∏î‡πÑ‡∏•‡∏û‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                <i class="fas fa-stop-circle card-icon"></i>
            </div>
            
            <!-- Alert Hours 1 Card (Dynamic) -->
            <div class="card status-warning" onclick="showDetail('live_alert1')">
                <div class="card-header">
                    <div class="card-title">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span id="alert1Title">&gt;36hr</span>
                    </div>
                    <div class="card-value" id="alert1Count">0</div>
                </div>
                <div class="card-description" id="alert1Desc">‡πÑ‡∏•‡∏û‡πå‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 36 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</div>
                <i class="fas fa-clock card-icon"></i>
            </div>
            
            <!-- Alert Hours 2 Card (Dynamic) -->
            <div class="card status-warning" onclick="showDetail('live_alert2')">
                <div class="card-header">
                    <div class="card-title">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span id="alert2Title">&gt;46hr</span>
                    </div>
                    <div class="card-value" id="alert2Count">0</div>
                </div>
                <div class="card-description" id="alert2Desc">‡πÑ‡∏•‡∏û‡πå‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 46 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</div>
                <i class="fas fa-clock card-icon"></i>
            </div>
            
            <!-- ‡πÑ‡∏•‡∏û‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î Card -->
            <div class="card status-live" onclick="showDetail('live_shopee')">
                <div class="card-header">
                    <div class="card-title">
                        <i class="fas fa-broadcast-tower"></i>
                        <span>‡πÑ‡∏•‡∏û‡πå‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</span>
                    </div>
                    <div class="card-value" id="liveCount">0</div>
                </div>
                <div class="card-description">‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÑ‡∏•‡∏û‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                <i class="fas fa-broadcast-tower card-icon"></i>
            </div>
            
            <!-- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô pytoon Card -->
            <div class="card" onclick="showDetail('no_pytoon')">
                <div class="card-header">
                    <div class="card-title">
                        <i class="fas fa-question-circle"></i>
                        <span>‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô pytoon</span>
                    </div>
                    <div class="card-value" id="noPytoonCount">0</div>
                </div>
                <div class="card-description">‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</div>
                <i class="fas fa-question-circle card-icon"></i>
            </div>
            
            <!-- ‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î‡∏à‡∏≠ new Card -->
            <div class="card" onclick="showDetail('moniter_new')">
                <div class="card-header">
                    <div class="card-title">
                        <i class="fas fa-desktop"></i>
                        <span>‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î‡∏à‡∏≠ new</span>
                    </div>
                    <div class="card-value" id="moniterNewCount">0</div>
                </div>
                <div class="card-description">‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î‡∏à‡∏≠‡∏´‡∏•‡∏±‡∏á‡∏ß‡∏±‡∏ô‡∏®‡∏∏‡∏Å‡∏£‡πå</div>
                <i class="fas fa-desktop card-icon"></i>
            </div>
            
            <!-- ‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î‡∏à‡∏≠ old Card -->
            <div class="card" onclick="showDetail('moniter_old')">
                <div class="card-header">
                    <div class="card-title">
                        <i class="fas fa-tv"></i>
                        <span>‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î‡∏à‡∏≠ old</span>
                    </div>
                    <div class="card-value" id="moniterOldCount">0</div>
                </div>
                <div class="card-description">‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î‡∏à‡∏≠‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡∏±‡∏ô‡∏®‡∏∏‡∏Å‡∏£‡πå</div>
                <i class="fas fa-tv card-icon"></i>
            </div>
            
            <!-- Account Work Card -->
            <div class="card" onclick="showDetail('acc_work')">
                <div class="card-header">
                    <div class="card-title">
                        <i class="fas fa-user-check"></i>
                        <span>‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏û‡∏£‡πâ‡∏≠‡∏°</span>
                    </div>
                    <div class="card-value" id="accWorkCount">0</div>
                </div>
                <div class="card-description">‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ó‡∏µ‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</div>
                <i class="fas fa-user-check card-icon"></i>
            </div>
            
            <!-- Account Wait Card -->
            <div class="card" onclick="showDetail('acc_wait')">
                <div class="card-header">
                    <div class="card-title">
                        <i class="fas fa-user-clock"></i>
                        <span>‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</span>
                    </div>
                    <div class="card-value" id="accWaitCount">0</div>
                </div>
                <div class="card-description">‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</div>
                <i class="fas fa-user-clock card-icon"></i>
            </div>
            
            <!-- Moniter Test Card -->
            <div class="card" onclick="showDetail('moniter_test')">
                <div class="card-header">
                    <div class="card-title">
                        <i class="fas fa-vial"></i>
                        <span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏î‡∏™‡∏≠‡∏ö</span>
                    </div>
                    <div class="card-value" id="moniterTestCount">0</div>
                </div>
                <div class="card-description">‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏î‡∏™‡∏≠‡∏ö</div>
                <i class="fas fa-vial card-icon"></i>
            </div>
        </div>
        
        <!-- Stop List Section - COMPACT VERSION -->
        <div class="stop-list">
            <div class="stop-list-header">
                <div class="stop-list-title">
                    <i class="fas fa-stop-circle"></i>
                    <span>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏´‡∏¢‡∏∏‡∏î‡πÑ‡∏•‡∏û‡πå</span>
                </div>
                <span class="badge badge-offline" id="stopBadge">0 ‡∏ä‡πà‡∏≠‡∏á</span>
            </div>
            <div class="stop-items" id="stopItems">
                <div class="empty-state">
                    <i class="fas fa-check-circle"></i>
                    <p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏´‡∏¢‡∏∏‡∏î‡πÑ‡∏•‡∏û‡πå</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Detail Container -->
    <div class="container detail-container" id="detailContainer">
        
        <div class="detail-top-bar"> 
            <button class="back-btn" onclick="showDashboard()">
                <i class="fas fa-arrow-left"></i>
                <span>‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</span>
            </button>
            
            <div class="detail-header" id="detailHeader">
                <div class="detail-title" id="detailTitle">
                    <i class="fas fa-table"></i>
                    <span>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</span>
                </div>

                <div class="filter-controls">
                    <select class="filter-select" id="adminFilterSelect" style="display: none;">
                        <option value="all">‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                    </select>

                    <select class="filter-select" id="svFilterSelect" style="display: none;">
                        <option value="all">SV ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                    </select>

                    <input type="text" class="filter-input" id="filterInput" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...">
                    <select class="filter-select" id="filterSelect">
                        <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                        <option value="channel">‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡πà‡∏≠‡∏á</option>
                        <option value="sim">‡∏™‡∏°‡∏∏‡∏î‡∏ã‡∏¥‡∏°</option>
                        <option value="phone">‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</option>
                        <option value="status">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option>
                        <option value="admin">‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</option>
                        <option value="server">‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå</option>
                    </select>
                </div>

            </div>
        </div>
        <div class="table-container">
            <div class="table-loading-overlay" id="tableLoadingOverlay">
                <div class="table-loading-spinner"></div>
                <div class="table-loading-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
                <div class="table-loading-subtext">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...</div>
            </div>
            
            <table class="data-table">
                <thead id="tableHeader">
                    </thead>
                <tbody id="tableBody">
                    </tbody>
            </table>
        </div>
    </div>

    
    
    <!-- Sound Control Buttons -->
    <div class="sound-control">
        <button class="sound-btn" id="soundToggle" onclick="toggleSound()" title="‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô">
            <i class="fas fa-volume-up" id="soundIcon"></i>
        </button>
    </div>
    
    <!-- Alert Toast -->
    <div class="alert-toast" id="alertToast">
        <i class="fas fa-exclamation-triangle"></i>
        <span id="alertMessage">‡∏°‡∏µ‡∏ä‡πà‡∏≠‡∏á‡∏´‡∏¢‡∏∏‡∏î‡πÑ‡∏•‡∏ü‡πå‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô!</span>
    </div>
    
    <!-- Modal ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ -->
    <div id="historyModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            
            <div class="history-header">
                <div class="history-title">
                    <i class="fas fa-chart-line"></i>
                    <span id="channelName">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ä‡πà‡∏≠‡∏á</span>
                </div>
                <div class="date-filter">
                    <button class="date-btn active" data-days="1">24 ‡∏ä‡∏°.</button>
                    <button class="date-btn" data-days="3">3 ‡∏ß‡∏±‡∏ô</button>
                    <button class="date-btn" data-days="7">7 ‡∏ß‡∏±‡∏ô</button>
                </div>
            </div>
            
            <!-- Loading -->
            <div class="loading-spinner" id="loadingSpinner">
                <div class="spinner-modal"></div>
                <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
            </div>
            
            <!-- Stats Cards -->
            <div class="stats-grid" id="statsGrid">
                <div class="stat-card">
                    <div class="stat-value" id="totalSales">‡∏ø0</div>
                    <div class="stat-label">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°</div>
                    <div class="stat-change positive">
                        <i class="fas fa-arrow-up"></i> <span>+0%</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalOrders">0</div>
                    <div class="stat-label">‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏£‡∏ß‡∏°</div>
                    <div class="stat-change positive">
                        <i class="fas fa-arrow-up"></i> <span>+0%</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalClicks">0</div>
                    <div class="stat-label">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏£‡∏ß‡∏°</div>
                    <div class="stat-change positive">
                        <i class="fas fa-arrow-up"></i> <span>+0%</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="avgConversion">0%</div>
                    <div class="stat-label">Conversion Rate</div>
                    <div class="stat-change">
                        <i class="fas fa-equals"></i> <span>‡∏Ñ‡∏á‡∏ó‡∏µ‡πà</span>
                    </div>
                </div>
            </div>
            
            <!-- Charts -->
            <div class="charts-grid">
                <div class="chart-card">
                    <div class="chart-title">
                        <i class="fas fa-dollar-sign"></i> ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢
                    </div>
                    <div class="chart-container">
                        <canvas id="salesChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <div class="chart-title">
                        <i class="fas fa-shopping-cart"></i> ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå & ‡∏Ñ‡∏•‡∏¥‡∏Å
                    </div>
                    <div class="chart-container">
                        <canvas id="ordersChart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Data Table -->
            <div class="history-table">
                <table>
                    <thead>
                        <tr>
                            <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏ß‡∏•‡∏≤</th>
                            <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                            <th>‡∏Ñ‡∏•‡∏¥‡∏Å</th>
                            <th>‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</th>
                            <th>‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</th>
                            <th>Conversion</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody">
                        <!-- ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏ï‡∏¥‡∏°‡∏î‡πâ‡∏ß‡∏¢ JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAd6-C6uVZO1JN_0YCprYW87gSUZsYi0nk",
            authDomain: "monitershopee.firebaseapp.com",
            databaseURL: "https://monitershopee-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "monitershopee",
            storageBucket: "monitershopee.firebasestorage.app",
            messagingSenderId: "283525812971",
            appId: "1:283525812971:web:c9ab4ba4bda355cb3a24ae"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // Settings Configuration
        const defaultSettings = {
            alertHours1: 36,
            alertHours2: 46,
            alertSound1: true,
            alertSound2: true,
            updateWarning: 10,
            updateCritical: 20,
            updateAlertSound: true,
            sortNewestFirst: true
        };
        
        let settings = { ...defaultSettings };
        
        // Global variables
        let currentData = {};
        let currentView = 'dashboard';
        let lastUpdateTime = null;
        let comHeaders = { com1: '', com2: '', com3: '' };
        let sortColumn = null;
        let sortDirection = 'desc'; // Default to newest first
        let currentChannelForHistory = null;
        let isProcessing = false;
        let allChannelNames = new Set();
        
        // Hourly cart data cache
        let hourlyCartDataCache = {};
        
        // Notification variables
        let soundEnabled = true;
        let lastStopCount = 0;
        let lastAlert1Count = 0;
        let lastAlert2Count = 0;
        let hasUserInteracted = false;
        let updateCheckInterval = null;
        let audioContext = null;
        
        // Chart variables
        let currentChannelHistory = {};
        let salesChart = null;
        let ordersChart = null;
        let miniCharts = {};
        
        // Sound frequencies for alerts
        const ALERT_FREQUENCIES = {
            stopIncrease: [800, 600, 800],
            alert1Warning: [600, 500, 600],
            alert2Warning: [700, 500, 700],
            timeWarning: [400, 400, 400]
        };
        
        // Chart configuration
        const chartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: {
                        color: '#ffffff'
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0,0,0,0.8)',
                    titleColor: '#ffffff',
                    bodyColor: '#ffffff',
                    borderColor: '#ee4d2d',
                    borderWidth: 1
                }
            },
            scales: {
                x: {
                    grid: {
                        color: 'rgba(255,255,255,0.1)'
                    },
                    ticks: {
                        color: '#a8b2d1'
                    }
                },
                y: {
                    grid: {
                        color: 'rgba(255,255,255,0.1)'
                    },
                    ticks: {
                        color: '#a8b2d1'
                    }
                }
            }
        };

        // Mini Chart Options
        const miniChartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: { enabled: false }
            },
            scales: {
                x: { display: false },
                y: { display: false }
            },
            elements: {
                point: { radius: 0 },
                line: { borderWidth: 1.5 }
            }
        };
        
        // Settings Functions
        function loadSettings() {
            const savedSettings = localStorage.getItem('monitorSettings');
            if (savedSettings) {
                settings = { ...defaultSettings, ...JSON.parse(savedSettings) };
            }
            applySettings();
        }
        
        function saveSettings() {
            // Get values from inputs
            settings.alertHours1 = parseInt(document.getElementById('alertHours1').value) || 36;
            settings.alertHours2 = parseInt(document.getElementById('alertHours2').value) || 46;
            settings.alertSound1 = document.getElementById('alertSound1').checked;
            settings.alertSound2 = document.getElementById('alertSound2').checked;
            settings.updateWarning = parseInt(document.getElementById('updateWarning').value) || 10;
            settings.updateCritical = parseInt(document.getElementById('updateCritical').value) || 20;
            settings.updateAlertSound = document.getElementById('updateAlertSound').checked;
            settings.sortNewestFirst = document.getElementById('sortNewestFirst').checked;
            
            // Save to localStorage
            localStorage.setItem('monitorSettings', JSON.stringify(settings));
            
            // Apply settings
            applySettings();
            
            // Refresh data
            updateAlertCounts();
            if (currentView !== 'dashboard') {
                updateDetailView(currentView);
            }
            
            // Close modal
            closeSettings();
            
            // Show success message
            showAlertToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!');
        }
        
        function resetSettings() {
            settings = { ...defaultSettings };
            
            // Update UI
            document.getElementById('alertHours1').value = settings.alertHours1;
            document.getElementById('alertHours2').value = settings.alertHours2;
            document.getElementById('alertSound1').checked = settings.alertSound1;
            document.getElementById('alertSound2').checked = settings.alertSound2;
            document.getElementById('updateWarning').value = settings.updateWarning;
            document.getElementById('updateCritical').value = settings.updateCritical;
            document.getElementById('updateAlertSound').checked = settings.updateAlertSound;
            document.getElementById('sortNewestFirst').checked = settings.sortNewestFirst;
            
            showAlertToast('‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!');
        }
        
        function applySettings() {
            // Update UI with current settings
            document.getElementById('alert1Title').textContent = `>${settings.alertHours1}hr`;
            document.getElementById('alert1Desc').textContent = `‡πÑ‡∏•‡∏û‡πå‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ ${settings.alertHours1} ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á`;
            document.getElementById('alert2Title').textContent = `>${settings.alertHours2}hr`;
            document.getElementById('alert2Desc').textContent = `‡πÑ‡∏•‡∏û‡πå‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ ${settings.alertHours2} ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á`;
            
            // Update input values
            document.getElementById('alertHours1').value = settings.alertHours1;
            document.getElementById('alertHours2').value = settings.alertHours2;
            document.getElementById('alertSound1').checked = settings.alertSound1;
            document.getElementById('alertSound2').checked = settings.alertSound2;
            document.getElementById('updateWarning').value = settings.updateWarning;
            document.getElementById('updateCritical').value = settings.updateCritical;
            document.getElementById('updateAlertSound').checked = settings.updateAlertSound;
            document.getElementById('sortNewestFirst').checked = settings.sortNewestFirst;
            
            // Update sort direction based on settings
            sortDirection = settings.sortNewestFirst ? 'desc' : 'asc';
        }
        
        function openSettings() {
            document.getElementById('settingsModal').classList.add('show');
        }
        
        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('show');
        }
        
        // Copy Channel Names Function
        function copyAllChannelNames() {
            const btn = document.getElementById('copyNamesBtn');
            const tooltip = document.getElementById('copyTooltip');
            const btnText = document.getElementById('copyBtnText');
            
            // NEW LOGIC: Collect from the rendered table
            let channelNames = [];
            const visibleRows = document.querySelectorAll('#tableBody tr');
            
            visibleRows.forEach(row => {
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÅ‡∏ñ‡∏ß‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å filter ‡∏≠‡∏≠‡∏Å)
                if (row.style.display !== 'none') {
                    // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ element ‡∏Ç‡∏≠‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡πà‡∏≠‡∏á
                    const channelLink = row.querySelector('.channel-link');
                    if (channelLink && channelLink.dataset.channel) {
                        channelNames.push(channelLink.dataset.channel);
                    }
                }
            });
            
            // Remove duplicates
            channelNames = [...new Set(channelNames)];

            if (channelNames.length === 0) {
                // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡πà‡∏≠‡∏á‡πÄ‡∏•‡∏¢
                btnText.textContent = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡πà‡∏≠‡∏á';
                tooltip.classList.remove('show');
                setTimeout(() => {
                    btnText.textContent = '‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡πà‡∏≠‡∏á';
                }, 2000);
                return;
            }
            
            // Copy to clipboard
            const text = channelNames.join('\n');
            navigator.clipboard.writeText(text).then(() => {
                // Update button
                btn.classList.add('copied');
                btnText.textContent = `‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å ${channelNames.length} ‡∏ä‡πà‡∏≠‡∏á ‡πÅ‡∏•‡πâ‡∏ß!`;
                tooltip.classList.add('show');
                
                // Reset after 2 seconds
                setTimeout(() => {
                    btn.classList.remove('copied');
                    btnText.textContent = '‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡πà‡∏≠‡∏á';
                    tooltip.classList.remove('show');
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy:', err);
                showAlertToast('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
            });
        }
        
        // LOADING FUNCTIONS
        function showTableLoading() {
            const overlay = document.getElementById('tableLoadingOverlay');
            if (overlay) {
                overlay.classList.add('show');
            }
            // Disable filter controls
            document.getElementById('filterInput').disabled = true;
            document.getElementById('filterSelect').disabled = true;
            isProcessing = true;
        }
        
        function hideTableLoading() {
            setTimeout(() => {
                const overlay = document.getElementById('tableLoadingOverlay');
                if (overlay) {
                    overlay.classList.remove('show');
                }
                // Enable filter controls
                document.getElementById('filterInput').disabled = false;
                document.getElementById('filterSelect').disabled = false;
                isProcessing = false;
            }, 300);
        }
        
        function showProcessingIndicator(text = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...') {
            const indicator = document.getElementById('processingIndicator');
            if (indicator) {
                indicator.querySelector('.processing-text').textContent = text;
                indicator.classList.add('show');
            }
        }
        
        function hideProcessingIndicator() {
            setTimeout(() => {
                const indicator = document.getElementById('processingIndicator');
                if (indicator) {
                    indicator.classList.remove('show');
                }
            }, 300);
        }
        
        // Debounce function to prevent multiple rapid calls
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        // =====================================================
        // HOURLY CART DATA FUNCTIONS (NEW)
        // =====================================================
        
        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• historical data ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á‡πÉ‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
        async function loadAllHourlyCartData(channelNames) {
            console.log(`üìä Loading hourly cart data for ${channelNames.length} channels...`);
            
            const now = new Date();
            const results = {};
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á keys ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö 6 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á (‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô Bot ‡∏≠‡∏≤‡∏à‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏£‡∏±‡∏ô)
            const hourKeys = [];
            for (let h = 1; h <= 6; h++) {  // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å h=1 (‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß)
                const targetTime = new Date(now.getTime() - h * 60 * 60 * 1000);
                // ‡πÉ‡∏ä‡πâ local timezone ‡πÅ‡∏ó‡∏ô UTC
                const year = targetTime.getFullYear();
                const month = String(targetTime.getMonth() + 1).padStart(2, '0');
                const day = String(targetTime.getDate()).padStart(2, '0');
                const dateKey = `${year}-${month}-${day}`;
                const hourKey = String(targetTime.getHours()).padStart(2, '0');
                hourKeys.push({ dateKey, hourKey, hoursAgo: h });
            }
            
            console.log('üìÖ Hour keys:', hourKeys.map(k => `${k.dateKey} ${k.hourKey}:00`));
            
            // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
            const promises = [];
            const channelHourMap = [];
            
            for (const channelName of channelNames) {
                if (!channelName || channelName === 'undefined') continue;
                
                for (const { dateKey, hourKey, hoursAgo } of hourKeys) {
                    const ref = database.ref(`historical_data_v2/${channelName}/${dateKey}/${hourKey}`);
                    promises.push(ref.once('value'));
                    channelHourMap.push({ channelName, hoursAgo, dateKey, hourKey });
                }
            }
            
            console.log(`üì° Fetching ${promises.length} historical records...`);
            
            try {
                const snapshots = await Promise.all(promises);
                
                // ‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                const rawData = {};
                let foundCount = 0;
                
                snapshots.forEach((snap, index) => {
                    const { channelName, hoursAgo, dateKey, hourKey } = channelHourMap[index];
                    if (!rawData[channelName]) {
                        rawData[channelName] = {};
                    }
                    const data = snap.val();
                    if (data) {
                        foundCount++;
                        // Debug: ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏û‡∏ö
                        if (foundCount <= 5) {
                            console.log(`‚úÖ Found data: ${channelName} @ ${dateKey} ${hourKey}:00 - added: ${data.added_to_cart || data.added || 0}`);
                        }
                    }
                    // ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á added_to_cart ‡πÅ‡∏•‡∏∞ added
                    rawData[channelName][hoursAgo] = data ? (data.added_to_cart || data.added || 0) : null;
                });
                
                console.log(`üì¶ Found ${foundCount} / ${promises.length} historical records`);
                
                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ú‡∏•‡∏ï‡πà‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ä‡πà‡∏≠‡∏á (‡πÉ‡∏ä‡πâ h=1 ‡∏ñ‡∏∂‡∏á h=6)
                for (const channelName of Object.keys(rawData)) {
                    const channelData = rawData[channelName];
                    results[channelName] = {
                        h1: calculateDiff(channelData[1], channelData[2]),
                        h2: calculateDiff(channelData[2], channelData[3]),
                        h3: calculateDiff(channelData[3], channelData[4]),
                        h4: calculateDiff(channelData[4], channelData[5]),
                        h5: calculateDiff(channelData[5], channelData[6])
                    };
                }
                
                // Debug: ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
                const sampleChannels = Object.keys(results).slice(0, 3);
                sampleChannels.forEach(ch => {
                    console.log(`üìà ${ch}: h1=${results[ch].h1}, h2=${results[ch].h2}, h3=${results[ch].h3}, h4=${results[ch].h4}, h5=${results[ch].h5}`);
                });
                
                console.log(`‚úÖ Loaded hourly data for ${Object.keys(results).length} channels`);
                hourlyCartDataCache = results;
                return results;
                
            } catch (error) {
                console.error('‚ùå Error loading hourly cart data:', error);
                return {};
            }
        }
        
        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ú‡∏•‡∏ï‡πà‡∏≤‡∏á (current - previous)
        function calculateDiff(current, previous) {
            if (current === null || previous === null) {
                return '-';
            }
            // ‡∏ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏Ñ‡∏π‡πà‡πÄ‡∏õ‡πá‡∏ô 0 (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ added ‡∏à‡∏£‡∏¥‡∏á) ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á -
            if (current === 0 && previous === 0) {
                return '-';
            }
            const diff = current - previous;
            return diff;
        }
        
        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• hourly cart ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ä‡πà‡∏≠‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß (‡πÉ‡∏ä‡πâ‡∏à‡∏≤‡∏Å cache)
        function getHourlyCartDisplay(channelName) {
            const data = hourlyCartDataCache[channelName];
            if (!data) {
                return { h1: '-', h2: '-', h3: '-', h4: '-', h5: '-' };
            }
            return data;
        }
        
        // Format hourly cart cell (‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏µ‡∏ï‡∏≤‡∏°‡∏Ñ‡πà‡∏≤)
        function formatHourlyCartCell(value) {
            if (value === '-' || value === null || value === undefined) {
                return '<td style="color: #666;">-</td>';
            }
            
            const numValue = parseInt(value);
            let color = '#a8b2d1'; // default gray
            
            if (numValue > 0) {
                color = '#4CAF50'; // green for positive
            } else if (numValue < 0) {
                color = '#f44336'; // red for negative
            }
            
            return `<td style="color: ${color}; font-weight: 500;">${numValue}</td>`;
        }
        
        // =====================================================
        // END HOURLY CART DATA FUNCTIONS
        // =====================================================
        
        // Initialize audio on first user interaction
        document.addEventListener('click', function initAudio() {
            if (!hasUserInteracted) {
                hasUserInteracted = true;
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                console.log('Audio initialized');
            }
        }, { once: true });
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadSettings();
            initializeFirebaseListeners();
            checkUpdateStatus();
            setInterval(checkUpdateStatus, 30000); // Check every 30 seconds
            
            // Initialize counts after data loads
            setTimeout(() => {
                if (currentData.stop_shopee) {
                    lastStopCount = Object.keys(currentData.stop_shopee || {}).length;
                }
                updateAlertCounts();
            }, 3000);
            
            // Setup modal event handlers
            setupModalHandlers();
        });
        
        // Firebase Listeners
        function initializeFirebaseListeners() {
            // Listen to metadata changes
            database.ref('shopee_monitor/metadata').on('value', (snapshot) => {
                const metadata = snapshot.val();
                if (metadata) {
                    updateDashboardStats(metadata.statistics);
                    updateLastUpdateTime(metadata.last_update_timestamp);
                    
                    // Get com headers from metadata - ‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏£‡∏∑‡∏≠ label
                    if (metadata.com_update) {
                        comHeaders.com1 = metadata.com_update.com1 || metadata.com_update1 || '1-11-25';
                        comHeaders.com2 = metadata.com_update.com2 || metadata.com_update2 || '31-10-25';
                        comHeaders.com3 = metadata.com_update.com3 || metadata.com_update3 || '30-10-25';
                    } else {
                        // Default dates if no metadata
                        comHeaders.com1 = '1-11-25';
                        comHeaders.com2 = '31-10-25';
                        comHeaders.com3 = '30-10-25';
                    }
                }
            });
            
            // Listen to all data collections
            const collections = ['live_shopee', 'stop_shopee', 'no_pytoon', 
                               'moniter_old', 'moniter_new', 'acc_work', 'acc_wait', 'moniter_test'];
            
            collections.forEach(collection => {
                database.ref(`shopee_monitor/${collection}`).on('value', (snapshot) => {
                    currentData[collection] = snapshot.val() || {};
                    
                    // Update counts
                    if (collection === 'live_shopee') {
                        updateAlertCounts();
                    }
                    
                    if (currentView === collection) {
                        updateDetailView(collection);
                    }
                    
                    // Update stop list if it's stop_shopee
                    if (collection === 'stop_shopee') {
                        checkForStopShopeeChanges(currentData[collection]);
                        updateStopList();
                    }
                });
            });
            
            // Load saved sound preference
            const savedSoundEnabled = localStorage.getItem('soundEnabled');
            if (savedSoundEnabled !== null) {
                soundEnabled = savedSoundEnabled === 'true';
                if (!soundEnabled) {
                    toggleSound(); // Update UI
                    soundEnabled = false; // Reset to saved state
                }
            }
            
            // Setup refresh interval for checking update time
            updateCheckInterval = setInterval(() => {
                if (lastUpdateTime) {
                    updateLastUpdateTime(lastUpdateTime);
                }
            }, 60000); // Check every 1 minute
        }
        
        // Update Alert Counts
        function updateAlertCounts() {
            const liveData = currentData.live_shopee || {};
            
            let alert1Count = 0;
            let alert2Count = 0;
            
            Object.values(liveData).forEach(item => {
                const hours = parseFloat(item.hours || item.time || 0);
                if (hours > settings.alertHours1) {
                    alert1Count++;
                }
                if (hours > settings.alertHours2) {
                    alert2Count++;
                }
            });
            
            // Check for changes and play sound
            if (alert1Count > lastAlert1Count && lastAlert1Count !== 0 && settings.alertSound1) {
                if (soundEnabled && hasUserInteracted) {
                    playAlert('alert1Warning');
                }
                showAlertToast(`‡∏°‡∏µ‡∏ä‡πà‡∏≠‡∏á‡πÑ‡∏•‡∏û‡πå‡πÄ‡∏Å‡∏¥‡∏ô ${settings.alertHours1} ‡∏ä‡∏°. ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô!`);
            }
            
            if (alert2Count > lastAlert2Count && lastAlert2Count !== 0 && settings.alertSound2) {
                if (soundEnabled && hasUserInteracted) {
                    playAlert('alert2Warning');
                }
                showAlertToast(`‡∏°‡∏µ‡∏ä‡πà‡∏≠‡∏á‡πÑ‡∏•‡∏û‡πå‡πÄ‡∏Å‡∏¥‡∏ô ${settings.alertHours2} ‡∏ä‡∏°. ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô!`);
            }
            
            // Update UI
            document.getElementById('alert1Count').textContent = alert1Count;
            document.getElementById('alert2Count').textContent = alert2Count;
            
            lastAlert1Count = alert1Count;
            lastAlert2Count = alert2Count;
        }
        
        // Update Dashboard Statistics
        function updateDashboardStats(stats) {
            if (stats) {
                document.getElementById('liveCount').textContent = stats.live_count || 0;
                document.getElementById('stopCount').textContent = stats.stop_count || 0;
                document.getElementById('noPytoonCount').textContent = stats.no_pytoon_count || 0;
                document.getElementById('moniterOldCount').textContent = stats.moniter_old_count || 0;
                document.getElementById('moniterNewCount').textContent = stats.moniter_new_count || 0;
                document.getElementById('accWorkCount').textContent = stats.acc_work_count || 0;
                document.getElementById('accWaitCount').textContent = stats.acc_wait_count || 0;
                document.getElementById('moniterTestCount').textContent = stats.moniter_test_count || 0;
            }
        }
        
        // Update Last Update Time with alerts based on settings
        function updateLastUpdateTime(timestamp) {
            lastUpdateTime = timestamp;
            const now = Date.now();
            const diff = now - timestamp;
            const minutes = Math.floor(diff / 60000);
            
            const updateElement = document.getElementById('lastUpdate');
            const statusElement = document.getElementById('updateStatus');
            
            if (minutes < 1) {
                updateElement.textContent = '‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà';
                statusElement.classList.remove('warning', 'warning-critical');
            } else {
                updateElement.textContent = `${minutes} ‡∏ô‡∏≤‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß`;
            }
            
            // Warning levels based on settings
            if (minutes >= settings.updateCritical) {
                statusElement.classList.remove('warning');
                statusElement.classList.add('warning-critical');
                // Play warning sound if enabled
                if (settings.updateAlertSound && soundEnabled && hasUserInteracted) {
                    playAlert('timeWarning');
                }
            } else if (minutes >= settings.updateWarning) {
                statusElement.classList.remove('warning-critical');
                statusElement.classList.add('warning');
            } else {
                statusElement.classList.remove('warning', 'warning-critical');
            }
        }
        
        // Check for Stop Shopee changes
        function checkForStopShopeeChanges(stopData) {
            const currentStopCount = Object.keys(stopData).length;
            
            if (currentStopCount > lastStopCount && lastStopCount !== 0) {
                // New stop detected
                if (soundEnabled && hasUserInteracted) {
                    playAlert('stopIncrease');
                }
                showAlertToast('‡∏°‡∏µ‡∏ä‡πà‡∏≠‡∏á‡∏´‡∏¢‡∏∏‡∏î‡πÑ‡∏•‡∏û‡πå‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô!');
            }
            
            lastStopCount = currentStopCount;
        }
        
        // COMPACT: Update Stop List
        function updateStopList() {
            const stopData = currentData.stop_shopee || {};
            const stopItems = document.getElementById('stopItems');
            const stopBadge = document.getElementById('stopBadge');
            
            const items = Object.values(stopData);
            stopBadge.textContent = `${items.length} ‡∏ä‡πà‡∏≠‡∏á`;
            
            if (items.length === 0) {
                stopItems.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-check-circle"></i>
                        <p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏´‡∏¢‡∏∏‡∏î‡πÑ‡∏•‡∏û‡πå</p>
                    </div>
                `;
                return;
            }
            
            // Sort by newest first if setting enabled
            if (settings.sortNewestFirst) {
                items.sort((a, b) => {
                    const timeA = a.stop_time || a.last_update || '';
                    const timeB = b.stop_time || b.last_update || '';
                    return timeB.localeCompare(timeA);
                });
            }
            
            let html = '';
            items.slice(0, 15).forEach(item => {
                // Use last update time or current time
                const stopTime = item.stop_time || item.last_update || getCurrentTime();
                const sales = item.sales || item.sale || 0;
                
                html += `
                    <div class="stop-item">
                        <div class="stop-item-left">
                            <div class="stop-item-channel">${item.channel || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠'}</div>
                            <div class="stop-item-time">${stopTime}</div>
                        </div>
                        <div class="stop-item-stats">
                            <div class="stop-stat">
                                <div class="stop-stat-value">${item.clicks || 0}</div>
                                <div class="stop-stat-label">‡∏Ñ‡∏•‡∏¥‡∏Å</div>
                            </div>
                            <div class="stop-stat">
                                <div class="stop-stat-value">${item.cart_count || 0}</div>
                                <div class="stop-stat-label">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>
                            </div>
                            <div class="stop-stat">
                                <div class="stop-stat-value">${item.added_to_cart || item.added || 0}</div>
                                <div class="stop-stat-label">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</div>
                            </div>
                            <div class="stop-stat">
                                <div class="stop-stat-value">${item.orders || item.order || 0}</div>
                                <div class="stop-stat-label">‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</div>
                            </div>
                            <div class="stop-stat">
                                <div class="stop-stat-value">${item.hours || item.time || 0}</div>
                                <div class="stop-stat-label">‡∏ä‡∏°.</div>
                            </div>
                            <div class="stop-stat">
                                <div class="stop-stat-value">‡∏ø${sales >= 1000 ? (sales/1000).toFixed(1) + 'k' : sales}</div>
                                <div class="stop-stat-label">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</div>
                            </div>
                        </div>
                        <div class="stop-item-badge">
                            <span class="badge badge-offline">OFFLINE</span>
                        </div>
                    </div>
                `;
            });
            
            if (items.length > 15) {
                html += `<div style="text-align: center; margin-top: 10px; color: var(--text-muted); font-size: 0.85rem;">
                            ‡πÅ‡∏•‡∏∞‡∏≠‡∏µ‡∏Å ${items.length - 15} ‡∏ä‡πà‡∏≠‡∏á...
                         </div>`;
            }
            
            stopItems.innerHTML = html;
        }
        
        // Helper function for current time
        function getCurrentTime() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            
            return `${year}-${month}-${day} ${hours}:${minutes}`;
        }
        
        // Check Update Status
        function checkUpdateStatus() {
            if (lastUpdateTime) {
                updateLastUpdateTime(lastUpdateTime);
            }
        }
        
        // Play Alert Sound
        function playAlert(type) {
            if (!audioContext || !soundEnabled) return;
            
            const frequencies = ALERT_FREQUENCIES[type] || ALERT_FREQUENCIES.stopIncrease;
            
            frequencies.forEach((freq, index) => {
                setTimeout(() => {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.value = freq;
                    gainNode.gain.value = 0.1;
                    
                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.2);
                }, index * 300);
            });
        }
        
        // Toggle Sound
        function toggleSound() {
            soundEnabled = !soundEnabled;
            const icon = document.getElementById('soundIcon');
            const button = document.getElementById('soundToggle');
            
            if (soundEnabled) {
                icon.className = 'fas fa-volume-up';
                button.classList.remove('muted');
            } else {
                icon.className = 'fas fa-volume-mute';
                button.classList.add('muted');
            }
            
            localStorage.setItem('soundEnabled', soundEnabled);
        }
        
        // Show Alert Toast
        function showAlertToast(message) {
            const toast = document.getElementById('alertToast');
            const messageEl = document.getElementById('alertMessage');
            
            messageEl.textContent = message;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 5000);
        }
        
        // Show Dashboard
        function showDashboard() {
            if (isProcessing) return;
            
            currentView = 'dashboard';
            document.getElementById('dashboard').style.display = 'block';
            document.getElementById('detailContainer').classList.remove('show');
        }
        
        // Show Detail View
        function showDetail(collection) {
            if (isProcessing) return;
            
            // Disable cards during loading
            document.querySelectorAll('.card').forEach(card => {
                card.classList.add('loading');
            });
            
            showProcessingIndicator('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...');
            
            setTimeout(() => {
                if (collection === 'live_alert1') {
                    // Show live > alert hours 1
                    showAlertDetail(settings.alertHours1, 1);
                } else if (collection === 'live_alert2') {
                    // Show live > alert hours 2
                    showAlertDetail(settings.alertHours2, 2);
                } else {
                    currentView = collection;
                    document.getElementById('dashboard').style.display = 'none';
                    document.getElementById('detailContainer').classList.add('show');
                    
                    updateDetailTitle(collection);
                    updateDetailView(collection);
                }
                
                // Re-enable cards
                document.querySelectorAll('.card').forEach(card => {
                    card.classList.remove('loading');
                });
                
                hideProcessingIndicator();
            }, 100);
        }
        
        // Show Alert Detail (for dynamic alert hours)
        function showAlertDetail(hours, level) {
            currentView = `live_alert${level}`;
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('detailContainer').classList.add('show');
            
            document.getElementById('detailTitle').innerHTML = `
                <i class="fas fa-exclamation-triangle"></i>
                <span>‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÑ‡∏•‡∏û‡πå‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ ${hours} ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</span>
            `;
            
            // Filter live_shopee data for > hours
            const filteredData = {};
            const liveData = currentData.live_shopee || {};
            
            Object.entries(liveData).forEach(([key, item]) => {
                const itemHours = parseFloat(item.hours || item.time || 0);
                if (itemHours > hours) {
                    filteredData[key] = item;
                }
            });
            
            updateDetailView('live_shopee', filteredData);
        }
        
        // Update Detail Title
        function updateDetailTitle(collection) {
            const titles = {
                'live_shopee': '<i class="fas fa-broadcast-tower"></i> ‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÑ‡∏•‡∏û‡πå',
                'stop_shopee': '<i class="fas fa-stop-circle"></i> ‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏´‡∏¢‡∏∏‡∏î‡πÑ‡∏•‡∏û‡πå',
                'no_pytoon': '<i class="fas fa-question-circle"></i> ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô pytoon',
                'moniter_old': '<i class="fas fa-tv"></i> ‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î‡∏à‡∏≠ old',
                'moniter_new': '<i class="fas fa-desktop"></i> ‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î‡∏à‡∏≠ new',
                'moniter_test': '<i class="fas fa-vial"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏î‡∏™‡∏≠‡∏ö',
                'acc_work': '<i class="fas fa-user-check"></i> ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô',
                'acc_wait': '<i class="fas fa-user-clock"></i> ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£'
            };
            
            document.getElementById('detailTitle').innerHTML = titles[collection] || '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î';
        }
        
        // Get Table Headers with additional fields
        function getTableHeaders(collection) {
            switch(collection) {
                case 'live_shopee':
                case 'stop_shopee':
                    return [
                        'Ph',     // NEW: phone
                        'SV', 
                        'admin', 
                        '‡∏ä‡πà‡∏≠‡∏á', 
                        'Pro',
                        'SS', 
                        'hr', 
                        '48‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á',
                        '‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏ß‡∏•‡∏≤', 
                        'Cl', 
                        'car',
                        'Or', 
                        'sale', 
                        '1',    // NEW: hourly cart diff (‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î)
                        '2',    // NEW: hourly cart diff
                        '3',    // NEW: hourly cart diff
                        '4',    // NEW: hourly cart diff
                        '5',    // NEW: hourly cart diff
                        '-',
                        'o',
                        comHeaders.com1 || '1-11-25',
                        comHeaders.com2 || '31-10-25',
                        comHeaders.com3 || '30-10-25'
                    ];
                    
                case 'moniter_old':
                case 'moniter_new':
                case 'moniter_test':
                    return [
                        '‡∏£‡∏´‡∏±‡∏™', 
                        '‡∏ä‡πà‡∏≠‡∏á', 
                        'Pro',
                        'SS', 
                        'hr', 
                        '48‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á',
                        '‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏ß‡∏•‡∏≤', 
                        'Cl', 
                        'car',
                        'Or', 
                        'sale', 
                        '1',    // NEW: hourly cart diff (‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î)
                        '2',    // NEW: hourly cart diff
                        '3',    // NEW: hourly cart diff
                        '4',    // NEW: hourly cart diff
                        '5',    // NEW: hourly cart diff
                        '-',
                        '‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô',
                        'o',
                        comHeaders.com1 || '1-11-25',
                        comHeaders.com2 || '31-10-25',
                        comHeaders.com3 || '30-10-25'
                    ];
                    
                case 'acc_work':
                case 'acc_wait':
                    return [
                        '‡∏£‡∏´‡∏±‡∏™', 
                        '‡∏ä‡πà‡∏≠‡∏á', 
                        '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞', 
                        'Live', 
                        comHeaders.com1 || '1-11-25',
                        comHeaders.com2 || '31-10-25',
                        comHeaders.com3 || '30-10-25'
                    ];
                    
                case 'no_pytoon':
                    return ['No', '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞', '‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡πà‡∏≠‡∏á'];
                    
                default:
                    return [];
            }
        }
        
        // Create Table Row with additional fields
        function createTableRow(item, collection) {
            const hourlyData = getHourlyCartDisplay(item.channel);
            
            // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ h1, h2, h3 = 0 ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏ñ‡πÄ‡∏Ç‡πá‡∏ô 3 ‡∏ä‡∏°.‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)
            const isNoCartAdded = (hourlyData.h1 === 0 && hourlyData.h2 === 0 && hourlyData.h3 === 0);
            const rowClass = isNoCartAdded ? 'class="no-cart-row"' : '';
            
            let row = `<tr ${rowClass}>`;
            
            switch(collection) {
                case 'live_shopee':
                case 'stop_shopee':
                    row += `<td>${item.phone || item.rank_phone || ''}</td>`; // Phone
                    row += `<td>${item.sim_book || ''}</td>`;
                    row += `<td>${item.code || ''}</td>`;
                    row += `<td><span class="channel-link" data-channel="${item.channel}">${item.channel || ''}</span></td>`;
                    row += `<td>${item.cart_count || 0}</td>`;
                    row += getSSLinkCell(item.ss); // <--- ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
                    row += `<td>${item.hours || item.time || 0}</td>`;
                    row += `<td>${item.end_time || item.endtime || item.hours_48 || 0}</td>`;
                    row += `<td>${item.start_time || ''}</td>`;
                    row += `<td>${item.clicks || 0}</td>`;
                    row += `<td>${item.added_to_cart || item.added || 0}</td>`;
                    row += `<td>${item.orders || item.order || 0}</td>`;
                    row += `<td>${formatCurrency(item.sales || item.sale || 0)}</td>`;
                    // NEW: 5 hourly cart difference columns
                    row += formatHourlyCartCell(hourlyData.h1);
                    row += formatHourlyCartCell(hourlyData.h2);
                    row += formatHourlyCartCell(hourlyData.h3);
                    row += formatHourlyCartCell(hourlyData.h4);
                    row += formatHourlyCartCell(hourlyData.h5);
                    row += `<td>${getLiveStatusBadge(item.live_status || item.live)}</td>`;
                    row += `<td>${item.server || item.rank_server || ''}</td>`; // Server
                    row += `<td>${item.com1 || item.com_update1 || 0}</td>`;
                    row += `<td>${item.com2 || item.com_update2 || 0}</td>`;
                    row += `<td>${item.com3 || item.com_update3 || 0}</td>`;
                    break;
                    
                case 'moniter_old':
                case 'moniter_new':
                case 'moniter_test':
                    row += `<td>${item.code || ''}</td>`;
                    row += `<td><span class="channel-link" data-channel="${item.channel}">${item.channel || ''}</span></td>`;
                    row += `<td>${item.cart_count || 0}</td>`;
                    row += getSSLinkCell(item.ss); // <--- ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
                    row += `<td>${item.hours || item.time || 0}</td>`;
                    row += `<td>${item.end_time || item.endtime || item.hours_48 || 0}</td>`;
                    row += `<td>${item.start_time || ''}</td>`;
                    row += `<td>${item.clicks || 0}</td>`;
                    row += `<td>${item.added_to_cart || item.added || 0}</td>`;
                    row += `<td>${item.orders || item.order || 0}</td>`;
                    row += `<td>${formatCurrency(item.sales || item.sale || 0)}</td>`;
                    // NEW: 5 hourly cart difference columns (only for moniter_old and moniter_new)
                    if (collection === 'moniter_old' || collection === 'moniter_new') {
                        row += formatHourlyCartCell(hourlyData.h1);
                        row += formatHourlyCartCell(hourlyData.h2);
                        row += formatHourlyCartCell(hourlyData.h3);
                        row += formatHourlyCartCell(hourlyData.h4);
                        row += formatHourlyCartCell(hourlyData.h5);
                    } else {
                        // moniter_test - no hourly data
                        row += '<td>-</td><td>-</td><td>-</td><td>-</td><td>-</td>';
                    }
                    row += `<td>${getLiveStatusBadge(item.live_status || item.live)}</td>`;
                    row += `<td>${item.admin || item.rank_admin || ''}</td>`; // Admin
                    row += `<td>${item.server || item.rank_server || ''}</td>`; // Server
                    row += `<td>${item.com1 || item.com_update1 || 0}</td>`;
                    row += `<td>${item.com2 || item.com_update2 || 0}</td>`;
                    row += `<td>${item.com3 || item.com_update3 || 0}</td>`;
                    break;
                    
                case 'acc_work':
                case 'acc_wait':
                    row += `<td>${item.code || ''}</td>`;
                    row += `<td><span class="channel-link" data-channel="${item.channel}">${item.channel || ''}</span></td>`;
                    row += `<td>${item.status || ''}</td>`;
                    row += `<td>${getLiveStatusBadge(item.live_status || item.live)}</td>`;
                    row += `<td>${item.com1 || item.com_update1 || 0}</td>`;
                    row += `<td>${item.com2 || item.com_update2 || 0}</td>`;
                    row += `<td>${item.com3 || item.com_update3 || 0}</td>`;
                    break;
                    
                case 'no_pytoon':
                    row += `<td>${item.no || ''}</td>`;
                    row += `<td>${item.rank_status || ''}</td>`;
                    row += `<td>${item.channel || ''}</td>`;
                    break;
            }
            
            row += '</tr>';
            return row;
        }
        
        // Get Live Status Badge
        function getLiveStatusBadge(status) {
            if (!status) return '';
            
            if (status === 'LIVE') {
                return '<span class="badge badge-live">LIVE</span>';
            } else if (status === 'OFFLINE') {
                return '<span class="badge badge-offline">OFFLINE</span>';
            } else {
                return `<span class="badge">${status}</span>`;
            }
        }
        
        // Format Currency
        function formatCurrency(amount) {
            return new Intl.NumberFormat('th-TH', {
                style: 'currency',
                currency: 'THB',
                minimumFractionDigits: 0
            }).format(amount);
        }

        // Helper function for SS Link
        function getSSLinkCell(ssValue) {
            const ss = ssValue || '';
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
            if (ss && /^[0-9]+$/.test(ss.trim())) { 
                return `<td><a href="https://live.shopee.co.th/share?from=live&session=${ss}" target="_blank" style="color: #4fb3d9; text-decoration: none;">${ss}</a></td>`;
            } else {
                return `<td>${ss}</td>`;
            }
        }

        // Setup Filter with debounce
        function setupFilter(collection) {
            const filterInput = document.getElementById('filterInput');
            const filterSelect = document.getElementById('filterSelect');
            const adminFilterSelect = document.getElementById('adminFilterSelect'); // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏°‡∏≤‡πÉ‡∏´‡∏°‡πà
            const svFilterSelect = document.getElementById('svFilterSelect'); // <-- ‡πÄ‡∏û‡∏¥‡πà‡∏° SV
            
            // Remove old listeners
            filterInput.replaceWith(filterInput.cloneNode(true));
            filterSelect.replaceWith(filterSelect.cloneNode(true));
            adminFilterSelect.replaceWith(adminFilterSelect.cloneNode(true)); // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏°‡∏≤‡πÉ‡∏´‡∏°‡πà
            svFilterSelect.replaceWith(svFilterSelect.cloneNode(true)); // <-- ‡πÄ‡∏û‡∏¥‡πà‡∏° SV
            
            // Get new elements
            const newFilterInput = document.getElementById('filterInput');
            const newFilterSelect = document.getElementById('filterSelect');
            const newAdminFilterSelect = document.getElementById('adminFilterSelect'); // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏°‡∏≤‡πÉ‡∏´‡∏°‡πà
            const newSvFilterSelect = document.getElementById('svFilterSelect'); // <-- ‡πÄ‡∏û‡∏¥‡πà‡∏° SV
            
            // Add debounced listener for input
            const debouncedFilter = debounce(() => {
                showProcessingIndicator('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...');
                setTimeout(() => {
                    filterTable(collection);
                    hideProcessingIndicator();
                }, 100);
            }, 300);
            
            newFilterInput.addEventListener('input', debouncedFilter);
            
            // Add listener for select change
            newFilterSelect.addEventListener('change', () => {
                showProcessingIndicator('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...');
                setTimeout(() => {
                    filterTable(collection);
                    hideProcessingIndicator();
                }, 100);
            });

            // Add listener for admin select change (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏°‡∏≤‡πÉ‡∏´‡∏°‡πà)
            newAdminFilterSelect.addEventListener('change', () => {
                showProcessingIndicator('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...');
                setTimeout(() => {
                    filterTable(collection);
                    hideProcessingIndicator();
                }, 100);
            });

            // Add listener for sv select change (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏°‡∏≤‡πÉ‡∏´‡∏°‡πà)
            newSvFilterSelect.addEventListener('change', () => {
                showProcessingIndicator('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...');
                setTimeout(() => {
                    filterTable(collection);
                    hideProcessingIndicator();
                }, 100);
            });
        }
        
        // Filter Table with additional fields
        function filterTable(collection) {
            const filterInput = document.getElementById('filterInput');
            const filterSelect = document.getElementById('filterSelect');
            const adminFilterSelect = document.getElementById('adminFilterSelect'); // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏°‡∏≤‡πÉ‡∏´‡∏°‡πà
            const svFilterSelect = document.getElementById('svFilterSelect'); // <-- ‡πÄ‡∏û‡∏¥‡πà‡∏° SV

            const filterValue = filterInput.value.toLowerCase();
            const filterType = filterSelect.value;
            const adminFilterValue = adminFilterSelect.value; // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏°‡∏≤‡πÉ‡∏´‡∏°‡πà
            const adminIndex = parseInt(adminFilterSelect.dataset.adminIndex, 10); // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏°‡∏≤‡πÉ‡∏´‡∏°‡πà
            const svFilterValue = svFilterSelect.value; // <-- ‡πÄ‡∏û‡∏¥‡πà‡∏° SV
            const svIndex = parseInt(svFilterSelect.dataset.svIndex, 10); // <-- ‡πÄ‡∏û‡∏¥‡πà‡∏° SV
            
            const rows = document.querySelectorAll('#tableBody tr');
            
            rows.forEach(row => {
                const cells = row.getElementsByTagName('td');
                let textSearchShouldShow = false; // ‡∏Å‡∏£‡∏≠‡∏á‡∏î‡πâ‡∏ß‡∏¢ text
                let adminFilterShouldShow = false; // ‡∏Å‡∏£‡∏≠‡∏á‡∏î‡πâ‡∏ß‡∏¢ admin
                let svFilterShouldShow = false; // <-- ‡πÄ‡∏û‡∏¥‡πà‡∏° SV
                
                // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Admin Filter (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏°‡∏≤‡πÉ‡∏´‡∏°‡πà)
                if (adminFilterValue === 'all' || adminIndex === -1) {
                    adminFilterShouldShow = true;
                } else {
                    if (cells[adminIndex] && cells[adminIndex].textContent.toLowerCase() === adminFilterValue.toLowerCase()) {
                        adminFilterShouldShow = true;
                    }
                }

                // 2. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö SV Filter (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏°‡∏≤‡πÉ‡∏´‡∏°‡πà)
                if (svFilterValue === 'all' || svIndex === -1) {
                    svFilterShouldShow = true;
                } else {
                    if (cells[svIndex] && cells[svIndex].textContent.toLowerCase() === svFilterValue.toLowerCase()) {
                        svFilterShouldShow = true;
                    }
                }

                // 3. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Text Search Filter (‡∏ï‡∏£‡∏£‡∏Å‡∏∞‡πÄ‡∏î‡∏¥‡∏°, ‡πÅ‡∏Å‡πâ‡πÄ‡∏•‡∏Ç‡∏à‡∏≤‡∏Å 2 ‡πÄ‡∏õ‡πá‡∏ô 3)
                if (filterValue === '') {
                    textSearchShouldShow = true;
                } else {
                    switch(filterType) {
                        case 'all':
                            for (let cell of cells) {
                                if (cell.textContent.toLowerCase().includes(filterValue)) {
                                    textSearchShouldShow = true;
                                    break;
                                }
                            }
                            break;
                        case 'channel':
                            const channelIndex = collection.includes('acc') ? 1 : 
                                               (collection.includes('moniter') ? 1 : 3);
                            if (cells[channelIndex] && cells[channelIndex].textContent.toLowerCase().includes(filterValue)) {
                                textSearchShouldShow = true;
                            }
                            break;
                        case 'sim':
                            // ‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå SV
                            if (svIndex !== -1 && cells[svIndex] && cells[svIndex].textContent.toLowerCase().includes(filterValue)) {
                                textSearchShouldShow = true;
                            }
                            break;
                        case 'phone':
                            if (cells[0] && cells[0].textContent.toLowerCase().includes(filterValue)) {
                                textSearchShouldShow = true;
                            }
                            break;
                        case 'admin':
                            // ‡πÉ‡∏ä‡πâ adminIndex ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡∏´‡∏≤‡πÑ‡∏ß‡πâ
                            if (adminIndex !== -1 && cells[adminIndex] && cells[adminIndex].textContent.toLowerCase().includes(filterValue)) {
                                textSearchShouldShow = true;
                            }
                            break;
                        case 'server':
                            // After adding 5 hourly cols, removing 1 graph col = +4
                            const serverIndex = collection.includes('live') || collection.includes('stop') ? 19 : 18;
                            if (cells[serverIndex] && cells[serverIndex].textContent.toLowerCase().includes(filterValue)) {
                                textSearchShouldShow = true;
                            }
                            break;
                        case 'status':
                            // After adding 5 hourly cols, removing 1 graph col = +4
                            const statusIndex = collection.includes('acc') ? 2 : 18;
                            if (cells[statusIndex] && cells[statusIndex].textContent.toLowerCase().includes(filterValue)) {
                                textSearchShouldShow = true;
                            }
                            break;
                    }
                }
                
                // ‡∏ï‡πâ‡∏≠‡∏á‡∏ú‡πà‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á 3 filter ‡∏ñ‡∏∂‡∏á‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á
                row.style.display = (adminFilterShouldShow && svFilterShouldShow && textSearchShouldShow) ? '' : 'none';
            });
        }
        
        // Sort Table with consistent direction and proper numeric sorting
        function sortTable(columnIndex) {
            if (isProcessing) return;
            
            showTableLoading();
            
            setTimeout(() => {
                // Toggle sort direction
                if (sortColumn === columnIndex) {
                    sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    sortColumn = columnIndex;
                    // Default based on settings
                    sortDirection = settings.sortNewestFirst ? 'desc' : 'asc';
                }
                
                // Update UI of header
                const headers = document.querySelectorAll('#tableHeader th');
                headers.forEach((header, index) => {
                    const icon = header.querySelector('i');
                    if (icon) {
                        if (index === columnIndex) {
                            icon.className = sortDirection === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down';
                            icon.style.color = '#ee4d2d';
                        } else {
                            icon.className = 'fas fa-sort';
                            icon.style.color = '';
                        }
                    }
                });
                
                // Re-render the current view with sorting
                if (currentView.startsWith('live_alert')) {
                    const level = currentView.replace('live_alert', '');
                    const hours = level === '1' ? settings.alertHours1 : settings.alertHours2;
                    showAlertDetail(hours, level);
                } else {
                    updateDetailView(currentView);
                }
            }, 100);
        }
        
        // Update Detail View with proper sorting
        async function updateDetailView(collection, customData = null) {
            showTableLoading();
            
            const data = customData || currentData[collection] || {};
            const tableHeader = document.getElementById('tableHeader');
            const tableBody = document.getElementById('tableBody');
            
            // Get items
            let items = Object.values(data);
            
            // Load hourly cart data for supported collections
            const collectionsWithHourly = ['live_shopee', 'stop_shopee', 'moniter_old', 'moniter_new'];
            if (collectionsWithHourly.includes(collection) && items.length > 0) {
                const channelNames = items.map(item => item.channel).filter(name => name && name !== 'undefined');
                await loadAllHourlyCartData(channelNames);
            }
            
            // Get headers
            const headers = getTableHeaders(collection);
            
            // ... (‡∏™‡πà‡∏ß‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡∏£‡πâ‡∏≤‡∏á headerHtml ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ...
            let headerHtml = '<tr>';
            headers.forEach((header, index) => {
                const sortIcon = sortColumn === index 
                    ? (sortDirection === 'asc' ? 'fa-sort-up' : 'fa-sort-down')
                    : 'fa-sort';
                const iconColor = sortColumn === index ? 'style="color: #ee4d2d;"' : '';
                
                headerHtml += `<th onclick="sortTable(${index})" style="cursor: pointer; user-select: none;">
                    ${header} <i class="fas ${sortIcon}" ${iconColor}></i>
                </th>`;
            });
            headerHtml += '</tr>';
            tableHeader.innerHTML = headerHtml;
            
            // ... (‡∏™‡πà‡∏ß‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î items.sort(...) ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ...
            if (sortColumn !== null && items.length > 0) {
                items.sort((a, b) => {
                    let aValue, bValue;
                    let fieldMap = [];
                    
                    if (collection === 'live_shopee' || collection === 'stop_shopee') {
                        fieldMap = [
                            'phone', 'sim_book', 'code', 'channel', 'cart_count', 'ss', 'hours', 'end_time', 
                            'start_time', 'clicks', 'added_to_cart', 'orders', 'sales', 
                            'h1', 'h2', 'h3', 'h4', 'h5',  // NEW: hourly fields
                            'live_status', 'server', 'com1', 'com2', 'com3'
                        ];
                    } else if (collection.includes('moniter') || collection === 'moniter_test') {
                        fieldMap = [
                            'code', 'channel', 'cart_count', 'ss', 'hours', 'end_time', 'start_time', 'clicks', 
                            'added_to_cart', 'orders', 'sales', 
                            'h1', 'h2', 'h3', 'h4', 'h5',  // NEW: hourly fields
                            'live_status', 'admin', 'server', 'com1', 'com2', 'com3'
                        ];
                    } else if (collection.includes('acc')) {
                        fieldMap = [
                            'code', 'channel', 'status', 'live_status', 'com1', 'com2', 'com3'
                        ];
                    } else if (collection === 'no_pytoon') {
                        fieldMap = ['no', 'rank_status', 'channel'];
                    }
                        
                        const field = fieldMap[sortColumn];
                        
                        if (field) {
                            aValue = a[field]; bValue = b[field];
                            if (field === 'phone') { aValue = a.phone || a.rank_phone || ''; bValue = b.phone || b.rank_phone || ''; }
                            if (field === 'server') { aValue = a.server || a.rank_server || ''; bValue = b.server || b.rank_server || ''; }
                            if (field === 'admin') { aValue = a.admin || a.rank_admin || ''; bValue = b.admin || b.rank_admin || ''; }
                            if (field === 'hours') { aValue = a.hours || a.time || 0; bValue = b.hours || b.time || 0; }
                            if (field === 'end_time') { aValue = a.end_time || a.endtime || a.hours_48 || 0; bValue = b.end_time || b.endtime || b.hours_48 || 0; }
                            if (field === 'added_to_cart') { aValue = a.added_to_cart || a.added || 0; bValue = b.added_to_cart || b.added || 0; }
                            if (field === 'orders') { aValue = a.orders || a.order || 0; bValue = b.orders || b.order || 0; }
                            if (field === 'sales') { aValue = a.sales || a.sale || 0; bValue = b.sales || b.sale || 0; }
                            if (field === 'live_status') { aValue = a.live_status || a.live || ''; bValue = b.live_status || b.live || ''; }
                            if (field.startsWith('com')) { const comNum = field.replace('com', ''); aValue = a[field] || a[`com_update${comNum}`] || 0; bValue = b[field] || b[`com_update${comNum}`] || 0; }
                            // NEW: Handle hourly fields from cache
                            if (field.startsWith('h') && field.length === 2) {
                                const aHourly = hourlyCartDataCache[a.channel] || {};
                                const bHourly = hourlyCartDataCache[b.channel] || {};
                                aValue = aHourly[field] === '-' ? -9999 : (aHourly[field] || 0);
                                bValue = bHourly[field] === '-' ? -9999 : (bHourly[field] || 0);
                            }
                        }
                        
                        if (aValue === undefined || bValue === undefined) return 0;
                        const aNum = parseFloat(String(aValue).replace(/[^0-9.-]/g, ''));
                        const bNum = parseFloat(String(bValue).replace(/[^0-9.-]/g, ''));
                        let comparison = 0;
                        if (!isNaN(aNum) && !isNaN(bNum)) { comparison = aNum - bNum; } else { const aStr = String(aValue || '').toLowerCase(); const bStr = String(bValue || '').toLowerCase(); if (aStr < bStr) comparison = -1; else if (aStr > bStr) comparison = 1; else comparison = 0; }
                        return sortDirection === 'asc' ? comparison : -comparison;
                    });
                }
                
                // ... (‡∏™‡πà‡∏ß‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î if (items.length === 0) ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ...
                if (items.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="${headers.length}" style="text-align: center; padding: 2rem;"><div class="empty-state"><i class="fas fa-inbox"></i><p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p></div></td></tr>`;
                    hideTableLoading();
                    return;
                }

                let bodyHtml = '';
                items.forEach(item => {
                    bodyHtml += createTableRow(item, collection);
                });
                tableBody.innerHTML = bodyHtml;
                
                // --- START: ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Admin Dropdown ---
                const adminFilter = document.getElementById('adminFilterSelect');
                let adminIndex = -1;
                let adminField = null;

                if (collection === 'live_shopee' || collection === 'stop_shopee') {
                    adminIndex = 2; // 'code'
                    adminField = 'code';
                } else if (collection.includes('moniter')) {
                    adminIndex = 17; // 'admin' (after adding 5 hourly cols, removing 1 graph col = +4)
                    adminField = 'admin';
                } else if (collection.includes('acc')) {
                    adminIndex = 0; // 'code'
                    adminField = 'code';
                }
                
                if (adminIndex !== -1 && adminField) {
                    const adminNames = [...new Set(items.map(item => item[adminField] || ''))]
                                        .filter(name => name !== '');
                    adminNames.sort();
                    
                    let adminOptions = '<option value="all">‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>';
                    adminNames.forEach(name => {
                        adminOptions += `<option value="${name}">${name}</option>`;
                    });
                    adminFilter.innerHTML = adminOptions;
                    adminFilter.style.display = 'inline-block';
                    adminFilter.dataset.adminIndex = adminIndex; // ‡πÄ‡∏Å‡πá‡∏ö index ‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô filter
                } else {
                    adminFilter.style.display = 'none';
                    adminFilter.value = 'all';
                    adminFilter.dataset.adminIndex = -1;
                }
                // --- END: ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Admin Dropdown ---

                // --- START: ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö SV Dropdown ---
                const svFilter = document.getElementById('svFilterSelect');
                let svIndex = -1;
                let svField = null;

                if (collection === 'live_shopee' || collection === 'stop_shopee') {
                    svIndex = 1; // 'SV'
                    svField = 'sim_book';
                }
                
                if (svIndex !== -1 && svField) {
                    const svNames = [...new Set(items.map(item => item[svField] || ''))]
                                        .filter(name => name !== '');
                    svNames.sort();
                    
                    let svOptions = '<option value="all">SV ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>';
                    svNames.forEach(name => {
                        svOptions += `<option value="${name}">${name}</option>`;
                    });
                    svFilter.innerHTML = svOptions;
                    svFilter.style.display = 'inline-block';
                    svFilter.dataset.svIndex = svIndex; // ‡πÄ‡∏Å‡πá‡∏ö index ‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô filter
                } else {
                    svFilter.style.display = 'none';
                    svFilter.value = 'all';
                    svFilter.dataset.svIndex = -1;
                }
                // --- END: ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö SV Dropdown ---

                // Setup filter
                setupFilter(collection);
                
                // Add channel click handlers (‡∏•‡∏ö createMiniChart ‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß)
                setTimeout(() => {
                    addChannelClickHandlers();
                    hideTableLoading();
                }, 100);
        }
        
        // Create Mini Chart
        async function createMiniChart(canvasId, channelName) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            
            try {
                // Get current channel data
                let currentChannelData = null;
                const collections = ['live_shopee', 'stop_shopee', 'moniter_old', 'moniter_new', 'moniter_test'];
                
                for (const collection of collections) {
                    if (currentData[collection]) {
                        const items = Object.values(currentData[collection]);
                        const found = items.find(item => item.channel === channelName);
                        if (found) {
                            currentChannelData = found;
                            break;
                        }
                    }
                }
                
                // Destroy old chart if exists
                if (miniCharts[canvasId]) {
                    miniCharts[canvasId].destroy();
                }
                
                const ctx = canvas.getContext('2d');
                
                // If no data or sales = 0, show flat line
                if (!currentChannelData || parseFloat(currentChannelData.sales || currentChannelData.sale || 0) === 0) {
                    // Show flat line at 0
                    miniCharts[canvasId] = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: Array(10).fill(''),
                            datasets: [{
                                data: Array(10).fill(0),
                                borderColor: 'rgba(150, 150, 150, 0.3)',
                                backgroundColor: 'rgba(150, 150, 150, 0.05)',
                                fill: true,
                                tension: 0.4,
                                borderWidth: 1,
                                pointRadius: 0
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false },
                                tooltip: { 
                                    enabled: true,
                                    callbacks: {
                                        label: function() {
                                            return '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
                                        }
                                    }
                                }
                            },
                            scales: {
                                x: { display: false },
                                y: { 
                                    display: false,
                                    min: 0,
                                    max: 1
                                }
                            }
                        }
                    });
                } else {
                    // Has sales data - show trend line
                    const currentSales = parseFloat(currentChannelData.sales || currentChannelData.sale || 0);
                    const chartData = [];
                    const numPoints = 10;
                    
                    // Create smooth curve up to current sales
                    for (let i = 0; i <= numPoints; i++) {
                        const progress = i / numPoints;
                        // Use easing function for smooth curve
                        const easeProgress = progress < 0.5 
                            ? 2 * progress * progress 
                            : 1 - Math.pow(-2 * progress + 2, 2) / 2;
                        chartData.push(currentSales * easeProgress);
                    }
                    
                    miniCharts[canvasId] = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: Array(numPoints + 1).fill(''),
                            datasets: [{
                                data: chartData,
                                borderColor: '#ee4d2d',
                                backgroundColor: 'rgba(238, 77, 45, 0.2)',
                                fill: true,
                                tension: 0.4,
                                borderWidth: 1.5,
                                pointRadius: 0
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false },
                                tooltip: { 
                                    enabled: true,
                                    mode: 'index',
                                    intersect: false,
                                    callbacks: {
                                        label: function(context) {
                                            return '‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢: ‡∏ø' + Math.round(context.parsed.y).toLocaleString('th-TH');
                                        }
                                    }
                                }
                            },
                            scales: {
                                x: { display: false },
                                y: { 
                                    display: false,
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                }
                
                // Add click event
                canvas.onclick = () => loadChannelHistory(channelName, 1);
                canvas.style.cursor = 'pointer';
                
            } catch (error) {
                console.error(`Error creating mini chart for ${channelName}:`, error);
            }
        }
        
        // Process Historical Data
        function processHistoricalData(data, startDate, endDate) {
            const processed = [];
            
            // Collect all available data points
            for (const dateKey in data) {
                const dateData = data[dateKey];
                
                for (const hourKey in dateData) {
                    const hourData = dateData[hourKey];
                    const timestamp = new Date(`${dateKey} ${hourKey}:00:00`);
                    
                    if (timestamp >= startDate && timestamp <= endDate) {
                        processed.push({
                            timestamp: timestamp,
                            dateKey: dateKey,
                            hourKey: hourKey,
                            ...hourData
                        });
                    }
                }
            }
            
            // Sort by timestamp
            processed.sort((a, b) => a.timestamp - b.timestamp);
            
            return processed;
        }
        
        // Load Channel History with working date filter
        async function loadChannelHistory(channelName, days = 1) {
            const modal = document.getElementById('historyModal');
            const spinner = document.getElementById('loadingSpinner');
            
            // Disable date buttons during loading
            document.querySelectorAll('.date-btn').forEach(btn => {
                btn.disabled = true;
            });
            
            // Store current channel for date filter
            currentChannelForHistory = channelName;
            
            // Show modal and loading
            modal.style.display = 'block';
            spinner.classList.add('active');
            
            // Update channel name
            document.getElementById('channelName').textContent = `‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ä‡πà‡∏≠‡∏á: ${channelName}`;
            
            // Update active button
            document.querySelectorAll('.date-btn').forEach(btn => {
                btn.classList.remove('active');
                if (parseInt(btn.dataset.days) === days) {
                    btn.classList.add('active');
                }
            });
            
            try {
                // Calculate date range
                const endDate = new Date();
                const startDate = new Date();
                startDate.setDate(startDate.getDate() - days);
                
                // Fetch data from Firebase
                const historicalRef = database.ref(`historical_data_v2/${channelName}`);
                const snapshot = await historicalRef.once('value');
                const data = snapshot.val() || {};
                
                // Process data
                currentChannelHistory = processHistoricalData(data, startDate, endDate);
                
                // Update UI
                updateStats(currentChannelHistory);
                updateCharts(currentChannelHistory);
                updateHistoryTable(currentChannelHistory);
                
            } catch (error) {
                console.error('Error loading history:', error);
                // If no historical data, show empty state
                document.getElementById('statsGrid').style.display = 'none';
                document.querySelector('.charts-grid').style.display = 'none';
                document.querySelector('.history-table').innerHTML = `
                    <div class="empty-state" style="padding: 3rem;">
                        <i class="fas fa-info-circle" style="font-size: 3rem; color: var(--text-muted);"></i>
                        <p style="margin-top: 1rem; color: var(--text-muted);">
                            ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥<br>
                            <small>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡πá‡∏ö‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó Bot</small>
                        </p>
                    </div>
                `;
            } finally {
                spinner.classList.remove('active');
                // Re-enable date buttons
                document.querySelectorAll('.date-btn').forEach(btn => {
                    btn.disabled = false;
                });
            }
        }
        
        // Update Statistics
        function updateStats(history) {
            if (history.length === 0) {
                document.getElementById('totalSales').textContent = '‡∏ø0';
                document.getElementById('totalOrders').textContent = '0';
                document.getElementById('totalClicks').textContent = '0';
                document.getElementById('avgConversion').textContent = '0%';
                return;
            }
            
            // Calculate totals
            const totals = history.reduce((acc, item) => {
                acc.sales += parseFloat(item.sales || 0);
                acc.orders += parseInt(item.orders || 0);
                acc.clicks += parseInt(item.clicks || 0);
                return acc;
            }, { sales: 0, orders: 0, clicks: 0 });
            
            // Calculate conversion rate
            const conversionRate = totals.clicks > 0 ? 
                ((totals.orders / totals.clicks) * 100).toFixed(2) : 0;
            
            // Update DOM
            document.getElementById('totalSales').textContent = 
                `‡∏ø${totals.sales.toLocaleString('th-TH')}`;
            document.getElementById('totalOrders').textContent = 
                totals.orders.toLocaleString('th-TH');
            document.getElementById('totalClicks').textContent = 
                totals.clicks.toLocaleString('th-TH');
            document.getElementById('avgConversion').textContent = 
                `${conversionRate}%`;
            
            // Calculate change percentages
            updateChangeIndicators(history);
        }
        
        // Update Change Indicators
        function updateChangeIndicators(history) {
            if (history.length < 2) return;
            
            const midPoint = Math.floor(history.length / 2);
            const firstHalf = history.slice(0, midPoint);
            const secondHalf = history.slice(midPoint);
            
            // Calculate sums for each half
            const firstSum = calculateSum(firstHalf);
            const secondSum = calculateSum(secondHalf);
            
            // Update change indicators
            updateChangeIndicator('sales', firstSum.sales, secondSum.sales, 0);
            updateChangeIndicator('orders', firstSum.orders, secondSum.orders, 1);
            updateChangeIndicator('clicks', firstSum.clicks, secondSum.clicks, 2);
        }
        
        function calculateSum(data) {
            return data.reduce((acc, item) => {
                acc.sales += parseFloat(item.sales || 0);
                acc.orders += parseInt(item.orders || 0);
                acc.clicks += parseInt(item.clicks || 0);
                return acc;
            }, { sales: 0, orders: 0, clicks: 0 });
        }
        
        function updateChangeIndicator(type, oldValue, newValue, index) {
            const statCards = document.querySelectorAll('.stat-change');
            if (!statCards[index]) return;
            
            const change = oldValue > 0 ? 
                (((newValue - oldValue) / oldValue) * 100).toFixed(1) : 0;
            
            const element = statCards[index];
            const icon = element.querySelector('i');
            const text = element.querySelector('span');
            
            if (change > 0) {
                element.className = 'stat-change positive';
                icon.className = 'fas fa-arrow-up';
                text.textContent = `+${change}%`;
            } else if (change < 0) {
                element.className = 'stat-change negative';
                icon.className = 'fas fa-arrow-down';
                text.textContent = `${change}%`;
            } else {
                element.className = 'stat-change';
                icon.className = 'fas fa-equals';
                text.textContent = '‡∏Ñ‡∏á‡∏ó‡∏µ‡πà';
            }
        }
        
        // Update Charts - handle gaps properly
        function updateCharts(history) {
            if (history.length === 0) return;
            
            // Prepare data - filter out zero values to create gaps
            const labels = [];
            const salesData = [];
            const ordersData = [];
            const clicksData = [];
            
            history.forEach(item => {
                const label = `${item.dateKey.slice(5)} ${item.hourKey}:00`;
                const sales = parseFloat(item.sales || 0);
                const orders = parseInt(item.orders || 0);
                const clicks = parseInt(item.clicks || 0);
                
                labels.push(label);
                
                // Use null for missing data to create gaps in the chart
                salesData.push(sales > 0 ? sales : null);
                ordersData.push(orders > 0 ? orders : null);
                clicksData.push(clicks > 0 ? clicks : null);
            });
            
            // Destroy existing charts
            if (salesChart) salesChart.destroy();
            if (ordersChart) ordersChart.destroy();
            
            // Create Sales Chart
            const salesCtx = document.getElementById('salesChart').getContext('2d');
            salesChart = new Chart(salesCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ (‡∏ö‡∏≤‡∏ó)',
                        data: salesData,
                        borderColor: '#ee4d2d',
                        backgroundColor: 'rgba(238, 77, 45, 0.1)',
                        fill: true,
                        tension: 0.4,
                        spanGaps: false, // Don't connect null values
                        segment: {
                            borderDash: ctx => ctx.p0.skip || ctx.p1.skip ? [5, 5] : undefined
                        }
                    }]
                },
                options: {
                    ...chartOptions,
                    scales: {
                        ...chartOptions.scales,
                        y: {
                            ...chartOptions.scales.y,
                            beginAtZero: true,
                            ticks: {
                                ...chartOptions.scales.y.ticks,
                                callback: function(value) {
                                    return '‡∏ø' + value.toLocaleString('th-TH');
                                }
                            }
                        }
                    }
                }
            });
            
            // Create Orders & Clicks Chart
            const ordersCtx = document.getElementById('ordersChart').getContext('2d');
            ordersChart = new Chart(ordersCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå',
                            data: ordersData,
                            borderColor: '#4CAF50',
                            backgroundColor: 'rgba(76, 175, 80, 0.1)',
                            fill: true,
                            tension: 0.4,
                            yAxisID: 'y',
                            spanGaps: false
                        },
                        {
                            label: '‡∏Ñ‡∏•‡∏¥‡∏Å',
                            data: clicksData,
                            borderColor: '#4fb3d9',
                            backgroundColor: 'rgba(79, 179, 217, 0.1)',
                            fill: true,
                            tension: 0.4,
                            yAxisID: 'y1',
                            spanGaps: false
                        }
                    ]
                },
                options: {
                    ...chartOptions,
                    scales: {
                        ...chartOptions.scales,
                        y: {
                            ...chartOptions.scales.y,
                            type: 'linear',
                            display: true,
                            position: 'left',
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå',
                                color: '#4CAF50'
                            }
                        },
                        y1: {
                            ...chartOptions.scales.y,
                            type: 'linear',
                            display: true,
                            position: 'right',
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '‡∏Ñ‡∏•‡∏¥‡∏Å',
                                color: '#4fb3d9'
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    }
                }
            });
        }
        
        // Update History Table
        function updateHistoryTable(history) {
            const tbody = document.getElementById('historyTableBody');
            tbody.innerHTML = '';
            
            // Sort data by time (newest first) if setting enabled
            const sortedHistory = [...history];
            if (settings.sortNewestFirst) {
                sortedHistory.sort((a, b) => {
                    const dateA = new Date(a.timestamp || `${a.dateKey} ${a.hourKey}:00:00`);
                    const dateB = new Date(b.timestamp || `${b.dateKey} ${b.hourKey}:00:00`);
                    return dateB - dateA; // Sort newest to oldest
                });
            }
            
            sortedHistory.forEach(item => {
                const row = document.createElement('tr');
                const conversionRate = item.clicks > 0 ? 
                    ((item.orders / item.clicks) * 100).toFixed(2) : 0;
                
                const liveStatusBadge = item.live_status === 'LIVE' ? 
                    '<span style="color: #4CAF50; font-weight: bold;">üî¥ LIVE</span>' : 
                    '<span style="color: #999;">OFFLINE</span>';
                
                // Format date time properly
                const dateTime = formatDateTime(item.dateKey, item.hourKey);
                
                row.innerHTML = `
                    <td>${dateTime}</td>
                    <td>${liveStatusBadge}</td>
                    <td>${item.clicks || 0}</td>
                    <td>${item.orders || 0}</td>
                    <td>‡∏ø${(item.sales || 0).toLocaleString('th-TH')}</td>
                    <td>${conversionRate}%</td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // Helper function for formatting date and time
        function formatDateTime(dateKey, hourKey) {
            if (!dateKey || !hourKey) return '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
            
            // Ensure hour has 2 digits
            const hour = String(hourKey).padStart(2, '0');
            return `${dateKey} ${hour}:00`;
        }
        
        // Add Channel Click Handlers
        function addChannelClickHandlers() {
            document.querySelectorAll('.channel-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const channelName = this.dataset.channel;
                    
                    // NEW LOGIC: Copy to clipboard
                    if (channelName) {
                        navigator.clipboard.writeText(channelName).then(() => {
                            // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ß‡πà‡∏≤‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
                            const originalText = this.textContent;
                            this.textContent = '‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß!';
                            this.style.color = '#4CAF50'; // ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß
                            
                            setTimeout(() => {
                                this.textContent = originalText;
                                this.style.color = ''; // ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡πÄ‡∏î‡∏¥‡∏°
                            }, 1500);
                        }).catch(err => {
                            console.error('Failed to copy channel name:', err);
                        });
                    }
                    
                    // OLD LOGIC (‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏õ)
                    // loadChannelHistory(channelName, 1);
                });
            });
        }
        
        // Setup Modal Handlers
        function setupModalHandlers() {
            // Modal close handler
            document.querySelector('.close').onclick = function() {
                document.getElementById('historyModal').style.display = 'none';
            }
            
            // Date filter buttons
            document.querySelectorAll('.date-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    if (this.disabled) return;
                    
                    // Remove active class from all buttons
                    document.querySelectorAll('.date-btn').forEach(b => b.classList.remove('active'));
                    // Add active class to clicked button
                    this.classList.add('active');
                    
                    // Reload data with new date range
                    const days = parseInt(this.dataset.days);
                    if (currentChannelForHistory) {
                        loadChannelHistory(currentChannelForHistory, days);
                    }
                });
            });
            
            // Close modal when clicking outside
            window.onclick = function(event) {
                const modal = document.getElementById('historyModal');
                if (event.target == modal) {
                    modal.style.display = 'none';
                }
            }
        }
        
        // Auto refresh hourly cart data every 5 minutes
        setInterval(async () => {
            if (currentView !== 'dashboard' && !isProcessing) {
                // Refresh hourly cart data for current view
                const collectionsWithHourly = ['live_shopee', 'stop_shopee', 'moniter_old', 'moniter_new'];
                if (collectionsWithHourly.includes(currentView)) {
                    const visibleChannels = document.querySelectorAll('.channel-link');
                    const channelNames = Array.from(visibleChannels).map(link => link.dataset.channel).filter(name => name);
                    if (channelNames.length > 0) {
                        console.log('Auto-refreshing hourly cart data...');
                        await loadAllHourlyCartData(channelNames);
                        // Re-render table to update values
                        updateDetailView(currentView);
                    }
                }
            }
        }, 300000); // 5 minutes
    </script>
</body>
</html>